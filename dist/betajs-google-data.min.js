/*!
betajs-google-data - v0.0.1 - 2018-08-18
Copyright (c) Oliver Friedmann
Apache-2.0 Software License.
*/

(function(){var a=this.subScope();a.binding("module","global:BetaJS.DataSupport"),a.binding("base","global:BetaJS"),a.binding("data","global:BetaJS.Data"),a.define("module:",function(){return{guid:"40dfb24a-cf2c-4992-bf16-725d5177b5c9",version:"0.0.1"}}),a.assumeVersion("base:version","~1.0.96"),a.assumeVersion("data:version","~1.0.41"),a.define("module:Helpers.Google",["base:Promise","base:Time"],function(a,b){var c=require("googleapis"),d=require("@google-cloud/pubsub");return{getUserProfile:function(b){var d=a.create();return c.google.gmail("v1").users.getProfile({auth:b,userId:"me"},d.asyncCallbackFunc()),d.mapSuccess(function(a){return a.data})},oauth2:function(a,b,d){return new c.google.auth.OAuth2(a,b,d)},oauth2WithCredentials:function(a,b,c){var d=this.oauth2(a,b);return d.setCredentials(c),d},oauth2RefreshRequired:function(a){return a.credentials.expiry_date<b.now()},oauth2ForceRefresh:function(b){var c=a.create();return b.refreshAccessToken(c.asyncCallbackFunc()),c},oauth2EnsureRefreshed:function(b){return this.oauth2RefreshRequired(oauth)?this.oauth2ForceRefresh(b):a.value(!0)},oauth2GetToken:function(b,c){var d=a.create();return b.getToken(c,d.asyncCallbackFunc()),d},scopes:["profile","email","https://www.googleapis.com/auth/contacts.readonly","https://www.googleapis.com/auth/calendar","https://mail.google.com","https://www.googleapis.com/auth/contacts","https://www.googleapis.com/auth/pubsub","https://www.google.com/m8/feeds"],oauth2Url:function(a){return a.generateAuthUrl({access_type:"offline",prompt:"consent",scope:this.scopes})},gmailWatch:function(b,d){var e=a.create();return c.google.gmail("v1").users.watch({userId:"me",auth:b,resource:{labelIds:["INBOX"],topicName:"projects/"+d.project_id+"/topics/"+d.topic_name}},e.asyncCallbackFunc()),e},pubsubSubscribe:function(a,b,c){var e=new d({projectId:a.project_id,credentials:{private_key:a.private_key,client_email:a.client_email}}),f="projects/"+a.project_id+"/subscriptions/"+a.subscription_name;e.subscription(f).on("message",function(a){try{b.call(c,a.id,JSON.parse(a.data),a.attributes)}catch(d){console.log(d)}a.ack()})}}}),a.define("module:Net.Imap",["base:Class","base:Events.EventsMixin","base:Objs","base:Async","base:Promise","base:Types"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},[b,function(a){return{constructor:function(b,e){a.constructor.call(this),this.__quoted_printable=require("quoted-printable"),this.__html_strip=require("htmlstrip-native"),this.__auth=b,e=e||{},this.__options=e,this.__count=0,this.__Imap=require("imap"),this.__connected=!1,this.__imap=new this.__Imap(c.extend({tls:!0,tlsOptions:{rejectUnauthorized:!1}},b));var f=this;this.__imap.on("mail",function(a){f.__count+=a}),this.__imap.on("error",function(){f.trigger("error"),e.reconnect_on_error&&d.eventually(f.reconnect,[],f)})},destroy:function(){this.disconnect(),a.destroy.call(this)},connect:function(){if(this.__connected)return e.value(!0);this.__count=0;var a=this,b=e.create(),d=function(){b.error(!0),a.off("error",d)};return this.on("error",d),this.__imap.connect(),this.__imap.once("ready",function(){a.__connected=!0;var e=a.__options.mailbox||"INBOX";f.is_array(e)||(e=[e]),e=c.clone(e,1);var g=null,h=function(){0===e.length&&(b.error(g),a.__connected=!1);var c=e.shift();a.__imap.openBox(c,!0,function(c,e){if(c)return g=c,void h();a.on("error",d),a.__imap.on("mail",function(b){a.trigger("new_mail",b)}),b.asyncSuccess(!0)})};a.off("error",d),h()}),b},disconnect:function(){this.__connected&&(this.__imap.end(),this.__connected=!1)},reconnect:function(){this.disconnect(),this.connect()},count:function(){return this.__count},fetch:function(a,b){a=a||{};var c=[];"headers"in a&&!a.headers||c.push("HEADER.FIELDS (FROM TO SUBJECT DATE)"),"body"in a&&!a.body||c.push("TEXT");var d=1,e=100;if(a.seq_count?a.seq_end?(e=a.seq_end,d=e-a.seq_count+1):(d=a.seq_start||d,e=d+a.seq_count-1):(d=a.seq_start||d,e=a.seq_end||d+99),a.reverse){var f=e-d;e=this.__count-d+1,d=e-f}var g=this.__imap.seq.fetch(d+":"+e,{bodies:c,struct:!0});return this.__query(g)},__query:function(a){var b=this,c=[];a.on("message",function(a,d){var e={},f="",g="";a.on("body",function(a,b){a.on("data",function(a){"TEXT"===b.which?g+=a.toString("utf8"):f+=a.toString("utf8")})}),a.once("attributes",function(a){e=a}),a.once("end",function(){e.seqno=d;try{var a=b.__parse(b.__Imap.parseHeader(f),g,e);a&&c.push(a)}catch(h){}})});var d=e.create();return a.once("error",function(a){d.asyncError(a)}),a.once("end",function(){d.asyncSuccess(c)}),d},__parse:function(a,b,c){this.trigger("parse",a,b,c);var d={};if(d.uid=c.uid,d.threadid=c["x-gm-thrid"],d.id=c.uid,d.seqid=c.seqno,a&&a.subject&&a.subject.length>0&&(d.subject=a.subject[0]),a&&a.to&&a.to.length>0&&(d.to=a.to[0]),a&&a.from&&a.from.length>0&&(d.from=a.from[0]),a&&a.date&&a.date.length>0){var e=new Date(a.date[0]);d.time=e.getTime()}if(b){var f=c.struct,g=[];if(f.length>1)for(var h=f[0].params.boundary,i=b,j=i.indexOf(h),k=1;k<f.length;++k){var l=f[k][0]||{};if(i=i.substring(i.indexOf(h)+h.length),i=i.substring(i.indexOf("\r\n\r\n")+"\r\n\r\n".length),!l.disposition&&"text"===l.type){var m=i.indexOf(h)-j;g.push({meta:l,body:m>=0?i.substring(0,m):i})}}else g.push({meta:f[0],body:b});for(var n=null,o=null,p=0;p<g.length;++p){var q=g[p].body,r=g[p].meta.encoding.toLowerCase();try{q="quoted-printable"===r?this.__quoted_printable.decode(q).toString():new Buffer(q,r).toString()}catch(s){}"html"===g[p].meta.subtype?n=q:o=q}!o&&n&&(o=this.__html_strip.html_strip(n,{include_script:!1,include_style:!1,compact_whitespace:!0})),d.html_body=n,d.text_body=o}return d}}}])}),a.define("module:Net.Smtp",["base:Strings","base:Promise"],function(a,b){return{send:function(c,d){var e=require("emailjs");d.from=a.email_get_email(d.from),d.to=a.email_get_email(d.to),d.text_body&&(d.text=d.text_body,delete d.text_body);var f=b.create();return e.server.connect(c).send(e.message.create(d),f.asyncCallbackFunc()),f}}}),a.define("module:Stores.GoogleRawCalendarStore",["data:Stores.BaseStore","data:Queries","base:Promise","base:Objs","base:Time"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(b,c){a.constructor.call(this),this.__calendar=require("googleapis").google.calendar("v3"),this.__google=b,this.__calendarId=c},_query_capabilities:function(){return{limit:!0,skip:!1,sort:!0,query:b.fullQueryCapabilities()}},_query:function(a,b){if(a.id)return this.get(a.id).mapSuccess(function(a){return[a]});var e=c.create(),f=d.extend({auth:this.__google,calendarId:this.__calendarId,maxResults:b.limit||100,singleEvents:!0,timeZone:"UTC"},a);return this.__calendar.events.list(f,e.asyncCallbackFunc()),e.mapSuccess(function(a){return a.data.items},this)},_get:function(a){var b=c.create();return this.__calendar.events.get({auth:this.__google,calendarId:this.__calendarId,eventId:a},b.asyncCallbackFunc()),b},_remove:function(a){var b=c.create();return this.__calendar.events["delete"]({auth:this.__google,calendarId:this.__calendarId,eventId:a},b.asyncCallbackFunc()),b},_update:function(a,b){return c.value(b)},_insert:function(a){var b=c.create();return this.__calendar.events.quickAdd({auth:this.__google,calendarId:this.__calendarId,text:a.value},b.asyncCallbackFunc()),b.mapSuccess(function(b){return{id:b.eventId,value:a.value,start_date_utc:e.now(),start_date_utc_time_difference:null}})}}})}),a.define("module:Stores.GoogleCalendarStore",["data:Stores.TransformationStore","data:Queries","module:Stores.GoogleRawCalendarStore","base:Objs","base:Strings"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(b,d){a.constructor.call(this,new c(b,d),{destroy_store:!0})},_query_capabilities:function(){var b=a._query_capabilities.call(this);return b.sort=!0,b},_encodeData:function(a){var b={};return d.iter(a,function(a,c){"date"==c?b.Date=a:b[c]=a},this),b},_decodeData:function(a){if(a.value)return a;var b={id:a.id,value:a.summary,start_date_utc:null,start_date_utc_time_difference:null};if(a.start&&a.start.dateTime){var c=e.last_after(a.start.dateTime,"-").split(":");b.start_date_utc=new Date(a.start.dateTime).getTime(),b.start_date_utc_time_difference=60*parseInt(c[0],10)+parseInt(c[1],10)}return b},_encodeQuery:function(a,b){function c(a){d.iter(a,function(a,b){switch(b){case"start_date_utc":var d=a.$gte||a.$gt,f=a.$lte||a.$lt;d&&(e.timeMin=new Date(d).toISOString()),f&&(e.timeMax=new Date(f).toISOString());break;case"value":e.q=a;break;default:c(a)}})}var e={};return c(a),{query:e,options:b}}}})}),a.define("module:Stores.GoogleContactsStore",["data:Stores.BaseStore","data:Queries","base:Promise","base:Objs","base:Strings"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(b){a.constructor.call(this),this.__contacts=new(require("google-contacts").GoogleContacts)({token:b.credentials.access_token}),this.__google=b},_query_capabilities:function(){return{limit:!0,skip:!1,sort:!0,query:b.fullQueryCapabilities()}},_query:function(a,b){if(a.id)return this.get(a.id).mapSuccess(function(a){return[a]});b=b||{};var d=c.create();return this.__contacts.getContacts(d.asyncCallbackFunc(),{projection:"full","max-results":b.limit,q:[a.name||"",a.email||""].join(" ")}),d.mapSuccess(function(a){return a.map(this._decodePerson,this)},this)},_get:function(a){var b=c.create();return this.__contacts.getContact(b.asyncCallbackFunc(),{id:a}),b.mapSuccess(this._decodePerson,this)},_decodePerson:function(a){return a=a.entry||a,{id:a.id,name:a.name,email:a.email?a.email.toLowerCase():"",phoneNumber:a.phoneNumber}}}})}),a.define("module:Stores.GoogleRawMailStore",["data:Stores.BaseStore","data:Queries","base:Promise","base:Objs","base:Time","base:Types"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},function(a){return{constructor:function(b){a.constructor.call(this),this.__gmail=require("googleapis").google.gmail("v1"),this.__google=b},_query_capabilities:function(){return{limit:!0,skip:!1,sort:!0,query:{atom:!0,conditions:{$ct:!0,$ctic:!0,$sw:!0,$swic:!0}}}},__gmailExecute:function(a,b,e,f){return c.resilience(function(){var f=c.create(),g=this.__gmail.users;return b.split(".").forEach(function(a){g=g[a]}),g[a](d.extend({auth:this.__google,userId:"me"},e),f.asyncCallbackFunc()),f},this,f||5)},_get:function(a){var b=0===a.indexOf("r");return this.__gmailExecute("get",b?"drafts":"messages",{id:a,format:"full"}).mapSuccess(function(c){var d=b?c.data.message:c.data;return d.id=a,d})},getAttachment:function(a,b){return this.__gmailExecute("get","messages.attachments",{messageId:a,id:b})},__rawMessageByData:function(a){var b=require("mailcomposer"),e=b(d.filter({to:a.to,cc:a.cc,bcc:a.bcc,subject:a.subject,text:a.text_body,attachments:a.attachments},function(a){return!!a})),f=c.create();return e.build(function(a,b){f.asyncSuccess(b.toString("base64").replace(/\+/g,"-").replace(/\//g,"_"))}),f},_insert:function(a){var b=a.draft;return this.__rawMessageByData(a).mapSuccess(function(a){return this.__gmailExecute(b?"create":"send",b?"drafts":"messages",{resource:b?{message:{raw:a}}:{raw:a}}).mapSuccess(function(a){return this.get(a.data.id)},this)},this)},_query:function(a,b){if(a.id)return this.get(a.id).mapSuccess(function(a){return[a.data]});var e=null;if(a.threadId)e=this.__gmailExecute("get","threads",{id:a.threadId,maxResults:b.limit||100});else{var g=[];d.iter(a,function(a,b){f.is_object(a)?d.iter(a,function(a,c){"$ct"!==c&&"$ctic"!==c||g.push(b+":*"+a+"*"),"$sw"!==c&&"$swic"!==c||g.push(b+":"+a+"*")}):"sent"!==b&&"in_inbox"!==b&&"draft"!==b&&"starred"!==b&&"archived"!==b&&g.push(b+":"+a)});var h=[];a.in_inbox&&h.push("INBOX"),"archived"in a&&!a.archived&&h.push("INBOX"),a.sent&&h.push("SENT"),a.draft&&h.push("DRAFT"),a.starred&&h.push("STARRED");var i={maxResults:b.limit||100};h.length>0&&(i.labelIds=h),g.length>0&&(i.q=g.join(" ")),e=this.__gmailExecute("list","messages",i)}return e.mapSuccess(function(a){var b=c.and();d.iter(a.data.messages,function(a){b=b.and(this.get(a.id))},this);var e=b.end();return this.__allDrafts().mapError(function(){return e}).mapSuccess(function(a){var b={};return a.forEach(function(a){b[a.message.id]=a.id}),e.mapSuccess(function(a){return a.map(function(a){return b[a.id]&&(a.id=b[a.id]),a})})})},this)},_remove:function(a){return this.__gmailExecute("delete","messages",{id:a,format:"full"})},__allDrafts:function(){return this.__gmailExecute("list","drafts",{}).mapSuccess(function(a){return a.data.drafts||[]})},__draftByMsgId:function(a){return this.__allDrafts().mapSuccess(function(b){for(var d=0;d<b.length;++d)if(b[d].message.id===a)return b[d];return c.error("Not found")},this)},__draftByDraftId:function(a){return this.__gmailExecute("list","drafts",{}).mapSuccess(function(b){for(var d=0;d<b.data.drafts.length;++d)if(b.data.drafts[d].id===a)return b.data.drafts[d];return c.error("Not found")},this)},_update:function(a,b){return"draft"in b&&!b.draft?d.count(b)>1?(delete b.draft,this._update(a,b).mapSuccess(function(){return this._update(a,{draft:!1})},this)):this.__draftByDraftId(a).mapSuccess(function(a){return this.__gmailExecute("send","drafts",{resource:{id:a.id,message:a.message}}).mapSuccess(function(a){return this.get(a.data.id)},this)},this):this._get(a).mapSuccess(function(c){if(d.iter(c.payload.headers,function(a){a.name.toLowerCase()in b||(b[a.name.toLowerCase()]=a.value)}),!("text_body"in b)&&c.payload.body&&c.payload.body.data){var e=new Buffer(c.payload.body.data,"base64");b.text_body=e.toString()}return this.__rawMessageByData(d.extend(c,b)).mapSuccess(function(b){return this.__gmailExecute("update","drafts",{id:a,resource:{message:{raw:b}}}).mapSuccess(function(a){return this.get(a.data.id)},this)},this)},this).mapError(function(c){var d=[],e=[];return"in_inbox"in b&&(b.in_inbox?d:e).push("INBOX"),"archived"in b&&(b.archived?e:d).push("INBOX"),"read"in b&&(b.read?e:d).push("UNREAD"),"sent"in b&&(b.sent?d:e).push("SENT"),"draft"in b&&(b.draft?d:e).push("DRAFT"),"starred"in b&&(b.starred?d:e).push("STARRED"),this.__gmailExecute("modify","messages",{id:a,resource:{addLabelIds:d,removeLabelIds:e}})},this)}}})}),a.define("module:Stores.GoogleMailStore",["data:Stores.TransformationStore","data:Queries","module:Stores.GoogleRawMailStore","base:Objs"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(b){a.constructor.call(this,new c(b),{destroy_store:!0})},_query_capabilities:function(){var b=a._query_capabilities.call(this);return b.sort=!0,b},getAttachment:function(a,b){return this._store().getAttachment(a,b)},_encodeData:function(a){var b={labelIds:[]};return d.iter(a,function(a,c){null!==a&&a!==undefined&&("time"==c?b.Date=a:"threadid"==c?b.threadId=a:b[c]=("to"==c||"cc"==c||"bcc"==c)&&a.join?a.join(","):a)},this),0===b.labelIds.length&&delete b.labelIds,b},_decodeData:function(a){if(!a.payload)return a;var b={id:a.id,threadid:a.threadId,snippet:a.snippet,archived:!d.contains_value(a.labelIds,"INBOX"),attachments:[],to:[],cc:[],in_inbox:d.contains_value(a.labelIds,"INBOX"),read:!d.contains_value(a.labelIds,"UNREAD"),sent:d.contains_value(a.labelIds,"SENT"),draft:d.contains_value(a.labelIds,"DRAFT"),starred:d.contains_value(a.labelIds,"STARRED")};d.iter(a.labelIds,function(a){0===a.indexOf("CATEGORY_")&&(b.category=a.substring("CATEGORY_".length).toLowerCase())}),d.iter(a.payload.headers,function(a){"To"==a.name&&b.to.push(a.value),"Cc"==a.name&&b.cc.push(a.value),"From"==a.name&&(b.from=a.value),"Subject"==a.name&&(b.subject=a.value),"Date"==a.name&&(b.creation_time=Date.parse(a.value))});var c=function(a){d.iter(a,function(a){try{switch(a.mimeType){case"text/plain":b.text_body=new Buffer(a.body.data,"base64").toString();break;case"text/html":b.html_body=new Buffer(a.body.data,"base64").toString();break;case"multipart/alternative":c(a.parts);break;default:a.body&&a.body.attachmentId&&b.attachments.push({type:a.mimeType,filename:a.filename,id:a.body.attachmentId,size:a.body.size,internal:!!b.html_body&&b.html_body.indexOf("cid:"+a.filename)>=0})}}catch(d){}})};return c(a.payload.parts||[a.payload]),b}}})}),a.define("module:Stores.GooglePeopleStore",["data:Stores.BaseStore","data:Queries","base:Promise","base:Objs","base:Strings"],function(a,b,c,d,e,f){var g=["addresses","ageRanges","biographies","birthdays","braggingRights","coverPhotos","emailAddresses","events","genders","imClients","interests","locales","memberships","metadata","names","nicknames","occupations","organizations","phoneNumbers","photos","relations","relationshipInterests","relationshipStatuses","residences","skills","taglines","urls"];return a.extend({scoped:f},function(a){return{constructor:function(b){a.constructor.call(this),this.__people=require("googleapis").google.people("v1"),this.__google=b},_query_capabilities:function(){return{limit:!0,skip:!1,sort:!0,query:b.fullQueryCapabilities()}},_query:function(a,b){if(a.id)return this.get(a.id).mapSuccess(function(a){return[a]});var e=c.create();return this.__people.contactGroups.get(d.extend({auth:this.__google,resourceName:"contactGroups/all",maxMembers:b.limit||100},a),e.asyncCallbackFunc()),e.mapSuccess(function(a){var b=c.create();return this.__people.people.getBatchGet({auth:this.__google,resourceNames:a.data.memberResourceNames||[],personFields:g},b.asyncCallbackFunc()),b.mapSuccess(function(a){return a.data.responses.filter(function(a){return 200===a.httpStatusCode}).map(this._decodePerson,this)},this)},this)},_get:function(a){var b=c.create();return this.__people.people.get({auth:this.__google,resourceName:this._encodePersonId(a),personFields:g},b.asyncCallbackFunc()),b.mapSuccess(this._decodePerson,this)},_encodePersonId:function(a){return"people/"+e.strip_start(a,"people/")},_decodePersonId:function(a){return e.strip_start(a,"people/")},_decodePerson:function(a){var b=a.person||a,c={id:this._decodePersonId(b.resourceName),emailAddresses:(b.emailAddresses||[]).map(function(a){return a.value.toLowerCase()}).filter(function(a){return e.is_email_address(a)}),gender:b.genders?b.genders[0].value:undefined,displayName:b.names?b.names[0].displayName:undefined,familyName:b.names?b.names[0].familyName:undefined,givenName:b.names?b.names[0].givenName:undefined,organization:b.organizations?b.organizations[0].name:undefined,title:b.organizations?b.organizations[0].title:undefined,photos:(b.photos||[]).map(function(a){return a.url}).filter(function(a){return!!a})};return c.name=c.displayName,c.email=c.emailAddresses[0],c}}})}),a.define("module:Stores.ImapStore",["data:Stores.BaseStore","data:Stores.StoreException","base:Objs","module:Net.Imap","module:Net.Smtp"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(b){a.constructor.call(this,b),this.__imap=c.extend(c.clone(b.base,1),b.imap),this.__smtp=c.extend(c.clone(b.base,1),b.smtp),this.__imap_opts=b.imap_options||{},this.__imap_opts.reconnect_on_error=!1},test:function(){var a=new d(this.__imap,this.__imap_opts);return a.connect().callback(a.destroy,a)},_query_capabilities:function(){return{skip:!0,limit:!0}},_query:function(a,b){var c=new d(this.__imap,this.__imap_opts);return c.connect().mapSuccess(function(){var a={};return"skip"in b&&(a.seq_start=b.skip+1),"limit"in b&&(a.seq_count=b.limit),a.reverse=!0,c.fetch(a).success(function(a){c.destroy()},this)},this)},_insert:function(a){e.send(this.__smtp,{from:a.from,to:a.to,subject:a.subject,text_body:a.text_body}).mapCallback(function(c,d){return c?new b(c):(a.id=d.header["message-id"],a)})}}})})}).call(Scoped);