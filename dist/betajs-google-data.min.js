/*!
betajs-google-data - v0.0.10 - 2020-02-26
Copyright (c) Oliver Friedmann
Apache-2.0 Software License.
*/

var Scoped=function(){function a(a){function b(a){return{route:"string"==typeof a.route?a.route:null,parent:"object"==typeof a.parent?a.parent:null,ready:"boolean"==typeof a.ready&&a.ready,children:{},watchers:[],data:{},lazy:[]}}function c(a){if(!a.ready){if(a.parent&&!a.parent.ready)return void c(a.parent);if(a.route&&a.parent&&a.route in a.parent.data){a.data=a.parent.data[a.route],a.ready=!0;for(var b=0;b<a.watchers.length;++b)a.watchers[b].callback.call(a.watchers[b].context||this,a.data);a.watchers=[];for(var d in a.children)c(a.children[d])}}}function d(a){if(!a.ready){a.parent&&!a.parent.ready&&d(a.parent),a.ready=!0,a.parent&&j.tree&&"object"==typeof a.parent.data&&(a.parent.data[a.route]=a.data);for(var b=0;b<a.watchers.length;++b)a.watchers[b].callback.call(a.watchers[b].context||this,a.data);a.watchers=[]}}function e(a,b){if("object"==typeof b&&a.ready)for(var e in b)a.data[e]=b[e];else a.data=b;if("object"==typeof b)for(var f in b)a.children[f]&&(a.children[f].data=b[f]);d(a);for(var g in a.children)c(a.children[g])}function f(a){if(a.ready&&a.data)for(var b in a.data)delete a.data[b]}function g(a){if(!a)return k;for(var d=a.split("."),e=k,f=0;f<d.length;++f)d[f]in e.children?e=e.children[d[f]]:(e.children[d[f]]=b({parent:e,route:d[f]}),e=e.children[d[f]],c(e));return e}function h(a,b,c){if(a.ready)b.call(c||this,a.data);else if(a.watchers.push({callback:b,context:c}),a.lazy.length>0){var d=function(a){if(a.lazy.length>0){var b=a.lazy.shift();b.callback.call(b.context||this,a.data),d(a)}};d(a)}}function i(a,b,c){a=a||k,c=c||[],!a.ready&&0===a.lazy.length&&a.watchers.length>0&&c.push(b);for(var d in a.children){var e=a.children[d];c=i(e,(b?b+".":"")+e.route,c)}return c}var j={tree:"boolean"==typeof a.tree&&a.tree,global:"boolean"==typeof a.global&&a.global,root:"object"==typeof a.root?a.root:{}},k=b({ready:!0});if(j.tree)if(j.global){try{window&&(k.data=window)}catch(l){}try{global&&(k.data=global)}catch(l){}try{self&&(k.data=self)}catch(l){}}else k.data=j.root;return{extend:function(a,b){e(g(a),b)},set:function(a,b){var c=g(a);c.data&&f(c),e(c,b)},get:function(a){var b=g(a);return b.ready?b.data:null},lazy:function(a,b,c){var d=g(a);d.ready?b(c||this,d.data):d.lazy.push({callback:b,context:c})},digest:function(a){c(g(a))},obtain:function(a,b,c){h(g(a),b,c)},unresolvedWatchers:function(a){return i(g(a),a)},__export:function(){return{options:j,nsRoot:k}},__import:function(a){j=a.options,k=a.nsRoot}}}function b(e,f,g,h){var i=null,j=[],k=f,l=g,m=h,n=a({tree:!0}),o=a({tree:!1}),p={global:{namespace:m},root:{namespace:l},local:{namespace:n},"default":{namespace:o},parent:{namespace:k},scope:{namespace:n,readonly:!1}},q=function(a,b,c){var e=d.matchArgs(a,{options:"object",namespaceLocator:!0,dependencies:"array",hiddenDependencies:"array",callback:!0,context:"object"}),f=d.extend({lazy:this.options.lazy},e.options||{}),g=this.resolve(e.namespaceLocator),h=function(){this.require(e.dependencies,e.hiddenDependencies,function(){for(var f=[],h=0;h<arguments.length;++h)f.push(arguments[h]);if(f[f.length-1].ns=g,this.options.compile){for(var i=[],j=0;j<a.length;++j)i.push(d.stringify(a[j]));this.compiled+=this.options.ident+"."+b+"("+i.join(", ")+");\n\n"}this.options.dependencies&&(this.dependencies[g.path]=this.dependencies[g.path]||{},e.dependencies&&e.dependencies.forEach(function(a){this.dependencies[g.path][this.resolve(a).path]=!0},this),e.hiddenDependencies&&e.hiddenDependencies.forEach(function(a){this.dependencies[g.path][this.resolve(a).path]=!0},this));var k=this.options.compile?{}:e.callback.apply(e.context||this,f);c.call(this,g,k)},this)};return f.lazy?g.namespace.lazy(g.path,h,this):h.apply(this),this};return{getGlobal:d.method(c,c.getPath),setGlobal:d.method(c,c.setPath),options:{lazy:!1,ident:"Scoped",compile:!1,dependencies:!1},compiled:"",dependencies:{},nextScope:function(){return i||(i=b(this,n,l,m)),i},subScope:function(){var a=this.nextScope();return j.push(a),i=null,a},binding:function(b,c,e){if(!p[b]||!p[b].readonly){var f;f="string"!=d.typeOf(c)?{namespace:a({tree:!0,root:c}),path:null}:this.resolve(c),p[b]=d.extend(e,f)}return this},resolve:function(a){var b=a.split(":");if(1==b.length)throw"The locator '"+b[0]+"' requires a namespace.";var c=p[b[0]];if(!c)throw"The namespace '"+b[0]+"' has not been defined (yet).";return{namespace:c.namespace,path:c.path&&b[1]?c.path+"."+b[1]:c.path||b[1]}},define:function(){return q.call(this,arguments,"define",function(a,b){if(a.namespace.get(a.path))throw"Scoped namespace "+a.path+" has already been defined. Use extend to extend an existing namespace instead";a.namespace.set(a.path,b)})},assumeVersion:function(){var a=d.matchArgs(arguments,{assumption:!0,dependencies:"array",callback:!0,context:"object",error:"string"}),b=a.dependencies||[];b.unshift(a.assumption),this.require(b,function(){var b=arguments,c=b[0].replace(/[^\d\.]/g,"");b[0]=c.split(".");for(var e=0;e<b[0].length;++e)b[0][e]=parseInt(b[0][e],10);if("function"===d.typeOf(a.callback)){if(!a.callback.apply(a.context||this,a))throw"Scoped Assumption '"+a.assumption+"' failed, value is "+c+(a.error?", but assuming "+a.error:"")}else for(var f=(a.callback+"").replace(/[^\d\.]/g,"").split("."),g=0;g<Math.min(b[0].length,f.length);++g)if(parseInt(f[g],10)>b[0][g])throw"Scoped Version Assumption '"+a.assumption+"' failed, value is "+c+", but assuming at least "+a.callback})},extend:function(){return q.call(this,arguments,"extend",function(a,b){a.namespace.extend(a.path,b)})},require:function(){var a=d.matchArgs(arguments,{dependencies:"array",hiddenDependencies:"array",callback:"function",context:"object"});a.callback=a.callback||function(){};var b=a.dependencies||[],c=b.concat(a.hiddenDependencies||[]),e=c.length,f=[],g={};if(e)for(var h=function(b){this.i<f.length&&(f[this.i]=b),0===--e&&(f.push(g),a.callback.apply(a.context||this.ctx,f))},i=0;i<c.length;++i){var j=this.resolve(c[i]);i<b.length&&f.push(null),j.namespace.obtain(j.path,h,{ctx:this,i:i})}else f.push(g),a.callback.apply(a.context||this,f);return this},digest:function(a){var b=this.resolve(a);return b.namespace.digest(b.path),this},unresolved:function(a){var b=this.resolve(a);return b.namespace.unresolvedWatchers(b.path)},__export:function(){return{parentNamespace:k.__export(),rootNamespace:l.__export(),globalNamespace:m.__export(),localNamespace:n.__export(),privateNamespace:o.__export()}},__import:function(a){k.__import(a.parentNamespace),l.__import(a.rootNamespace),m.__import(a.globalNamespace),n.__import(a.localNamespace),o.__import(a.privateNamespace)}}}var c=function(){return{get:function(a){return"undefined"!=typeof window?a?window[a]:window:"undefined"!=typeof global?a?global[a]:global:"undefined"!=typeof self?a?self[a]:self:undefined},set:function(a,b){return"undefined"!=typeof window&&(window[a]=b),"undefined"!=typeof global&&(global[a]=b),"undefined"!=typeof self&&(self[a]=b),b},getPath:function(a){if(!a)return this.get();var b=a.split(".");if(1==b.length)return this.get(a);for(var c=this.get(b[0]),d=1;d<b.length;++d){if(!c)return c;c=c[b[d]]}return c},setPath:function(a,b){var c=a.split(".");if(1==c.length)return this.set(a,b);for(var d=this.get(c[0])||this.set(c[0],{}),e=1;e<c.length-1;++e)c[e]in d||(d[c[e]]={}),d=d[c[e]];return d[c[c.length-1]]=b,b}}}.call(this),d=function(){return{method:function(a,b){return function(){return b.apply(a,arguments)}},extend:function(a,b){a=a||{},b=b||{};for(var c in b)a[c]=b[c];return a},typeOf:function(a){return"[object Array]"===Object.prototype.toString.call(a)?"array":typeof a},isEmpty:function(a){if(null===a||void 0===a)return!0;if("array"==this.typeOf(a))return 0===a.length;if("object"!=typeof a)return!1;for(var b in a)return!1;return!0},matchArgs:function(a,b){var c=0,d={};for(var e in b)!0===b[e]||this.typeOf(a[c])==b[e]?(d[e]=a[c],c++):"undefined"==this.typeOf(a[c])&&c++;return d},stringify:function(a){return"function"==this.typeOf(a)?""+a:JSON.stringify(a)}}}.call(this),e=function(){return{__namespace:"Scoped",__revert:null,upgrade:function(a){var b=c.get(a||e.__namespace);if(b&&"object"==d.typeOf(b)&&b.guid==this.guid&&"string"==d.typeOf(b.version)){for(var f=this.version.split("."),g=b.version.split("."),h=!1,i=0;i<Math.min(f.length,g.length)&&(h=parseInt(f[i],10)>parseInt(g[i],10),f[i]==g[i]);++i);return h?this.attach(a):b}return this.attach(a)},attach:function(a){a&&(e.__namespace=a);var b=c.get(e.__namespace);if(b==this)return this;if(e.__revert=b,b)try{var d=b.__exportScoped();this.__exportBackup=this.__exportScoped(),this.__importScoped(d)}catch(f){}return c.set(e.__namespace,this),this},detach:function(a){return a&&c.set(e.__namespace,null),"undefined"!=typeof e.__revert&&c.set(e.__namespace,e.__revert),delete e.__revert,e.__exportBackup&&this.__importScoped(e.__exportBackup),this},exports:function(a,b,c){return a=a||("undefined"!=typeof module?module:null),"object"==typeof a&&a&&"exports"in a&&(c||a.exports==this||!a.exports||d.isEmpty(a.exports))&&(a.exports=b||this),this}}}.call(this),f=a({tree:!0,global:!0}),g=a({tree:!0}),h=b(null,g,g,f),i=d.extend(h,function(){return{guid:"4b6878ee-cb6a-46b3-94ac-27d91f58d666",version:"0.0.19",upgrade:e.upgrade,attach:e.attach,detach:e.detach,exports:e.exports,__exportScoped:function(){return{globalNamespace:f.__export(),rootNamespace:g.__export(),rootScope:h.__export()}},__importScoped:function(a){f.__import(a.globalNamespace),g.__import(a.rootNamespace),h.__import(a.rootScope)}}}.call(this));return i=i.upgrade(),i.exports(),i}.call(this);(function(){var a=this.subScope();a.binding("module","global:BetaJS.Data.Google"),a.binding("base","global:BetaJS"),a.binding("data","global:BetaJS.Data"),a.define("module:",function(){return{guid:"40dfb24a-cf2c-4992-bf16-725d5177b5c9",version:"0.0.10"}}),a.assumeVersion("base:version","~1.0.96"),a.assumeVersion("data:version","~1.0.41"),a.define("module:Helpers.Google",["base:Promise","base:Time"],function(a,b){var c=require("googleapis"),d=require("@google-cloud/pubsub");return{getUserProfile:function(b){var d=a.create();return c.google.gmail("v1").users.getProfile({auth:b,userId:"me"},d.asyncCallbackFunc()),d.mapSuccess(function(a){return a.data})},oauth2:function(a,b,d){return new c.google.auth.OAuth2(a,b,d)},oauth2WithCredentials:function(a,b,c){var d=this.oauth2(a,b);return d.setCredentials(c),d},oauth2RefreshRequired:function(a){return a.credentials.expiry_date<b.now()},oauth2ForceRefresh:function(b){var c=a.create();return b.refreshAccessToken(c.asyncCallbackFunc()),c},oauth2EnsureRefreshed:function(b){return this.oauth2RefreshRequired(oauth)?this.oauth2ForceRefresh(b):a.value(!0)},oauth2GetToken:function(b,c){var d=a.create();return b.getToken(c,d.asyncCallbackFunc()),d},oauth2Url:function(a,b){return a.generateAuthUrl({access_type:"offline",prompt:"consent",scope:b})},gmailWatch:function(b,d){var e=a.create();return c.google.gmail("v1").users.watch({userId:"me",auth:b,resource:{labelIds:["INBOX"],topicName:"projects/"+d.project_id+"/topics/"+d.topic_name}},e.asyncCallbackFunc()),e},pubsubSubscribe:function(a,b,c){var e=new d({projectId:a.project_id,credentials:{private_key:a.private_key,client_email:a.client_email}}),f="projects/"+a.project_id+"/subscriptions/"+a.subscription_name;e.subscription(f).on("message",function(a){try{b.call(c,a.id,JSON.parse(a.data),a.attributes)}catch(d){console.log(d)}a.ack()})}}}),a.define("module:Net.Imap",["base:Class","base:Events.EventsMixin","base:Objs","base:Async","base:Promise","base:Types"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},[b,function(a){return{constructor:function(b,e){a.constructor.call(this),this.__quoted_printable=require("quoted-printable"),this.__html_strip=require("htmlstrip-native"),this.__auth=b,e=e||{},this.__options=e,this.__count=0,this.__Imap=require("imap"),this.__connected=!1,this.__imap=new this.__Imap(c.extend({tls:!0,tlsOptions:{rejectUnauthorized:!1}},b));var f=this;this.__imap.on("mail",function(a){f.__count+=a}),this.__imap.on("error",function(){f.trigger("error"),e.reconnect_on_error&&d.eventually(f.reconnect,[],f)})},destroy:function(){this.disconnect(),a.destroy.call(this)},connect:function(){if(this.__connected)return e.value(!0);this.__count=0;var a=this,b=e.create(),d=function(){b.error(!0),a.off("error",d)};return this.on("error",d),this.__imap.connect(),this.__imap.once("ready",function(){a.__connected=!0;var e=a.__options.mailbox||"INBOX";f.is_array(e)||(e=[e]),e=c.clone(e,1);var g=null,h=function(){0===e.length&&(b.error(g),a.__connected=!1);var c=e.shift();a.__imap.openBox(c,!0,function(c,e){if(c)return g=c,void h();a.on("error",d),a.__imap.on("mail",function(b){a.trigger("new_mail",b)}),b.asyncSuccess(!0)})};a.off("error",d),h()}),b},disconnect:function(){this.__connected&&(this.__imap.end(),this.__connected=!1)},reconnect:function(){this.disconnect(),this.connect()},count:function(){return this.__count},fetch:function(a,b){a=a||{};var c=[];"headers"in a&&!a.headers||c.push("HEADER.FIELDS (FROM TO SUBJECT DATE)"),"body"in a&&!a.body||c.push("TEXT");var d=1,e=100;if(a.seq_count?a.seq_end?(e=a.seq_end,d=e-a.seq_count+1):(d=a.seq_start||d,e=d+a.seq_count-1):(d=a.seq_start||d,e=a.seq_end||d+99),a.reverse){var f=e-d;e=this.__count-d+1,d=e-f}var g=this.__imap.seq.fetch(d+":"+e,{bodies:c,struct:!0});return this.__query(g)},__query:function(a){var b=this,c=[];a.on("message",function(a,d){var e={},f="",g="";a.on("body",function(a,b){a.on("data",function(a){"TEXT"===b.which?g+=a.toString("utf8"):f+=a.toString("utf8")})}),a.once("attributes",function(a){e=a}),a.once("end",function(){e.seqno=d;try{var a=b.__parse(b.__Imap.parseHeader(f),g,e);a&&c.push(a)}catch(h){}})});var d=e.create();return a.once("error",function(a){d.asyncError(a)}),a.once("end",function(){d.asyncSuccess(c)}),d},__parse:function(a,b,c){this.trigger("parse",a,b,c);var d={};if(d.uid=c.uid,d.threadid=c["x-gm-thrid"],d.id=c.uid,d.seqid=c.seqno,a&&a.subject&&a.subject.length>0&&(d.subject=a.subject[0]),a&&a.to&&a.to.length>0&&(d.to=a.to[0]),a&&a.from&&a.from.length>0&&(d.from=a.from[0]),a&&a.date&&a.date.length>0){var e=new Date(a.date[0]);d.time=e.getTime()}if(b){var f=c.struct,g=[];if(f.length>1)for(var h=f[0].params.boundary,i=b,j=i.indexOf(h),k=1;k<f.length;++k){var l=f[k][0]||{};if(i=i.substring(i.indexOf(h)+h.length),i=i.substring(i.indexOf("\r\n\r\n")+"\r\n\r\n".length),!l.disposition&&"text"===l.type){var m=i.indexOf(h)-j;g.push({meta:l,body:m>=0?i.substring(0,m):i})}}else g.push({meta:f[0],body:b});for(var n=null,o=null,p=0;p<g.length;++p){var q=g[p].body,r=g[p].meta.encoding.toLowerCase();try{q="quoted-printable"===r?this.__quoted_printable.decode(q).toString():new Buffer(q,r).toString()}catch(s){}"html"===g[p].meta.subtype?n=q:o=q}!o&&n&&(o=this.__html_strip.html_strip(n,{include_script:!1,include_style:!1,compact_whitespace:!0})),d.html_body=n,d.text_body=o}return d}}}])}),a.define("module:Net.Smtp",["base:Strings","base:Promise"],function(a,b){return{send:function(c,d){var e=require("emailjs");d.from=a.email_get_email(d.from),d.to=a.email_get_email(d.to),d.text_body&&(d.text=d.text_body,delete d.text_body);var f=b.create();return e.server.connect(c).send(e.message.create(d),f.asyncCallbackFunc()),f}}}),a.define("module:Stores.GoogleRawCalendarStore",["data:Stores.BaseStore","data:Queries","base:Promise","base:Objs","base:Time"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(b,c){a.constructor.call(this),this.__calendar=require("googleapis").google.calendar("v3"),this.__google=b,this.__calendarId=c},_query_capabilities:function(){return{limit:!0,skip:!1,sort:!0,query:b.fullQueryCapabilities()}},_query:function(a,b){if(a.id)return this.get(a.id).mapSuccess(function(a){return[a]});var e=c.create(),f=d.extend({auth:this.__google,calendarId:this.__calendarId,maxResults:b.limit||100,singleEvents:!0,timeZone:"UTC"},a);return this.__calendar.events.list(f,e.asyncCallbackFunc()),e.mapSuccess(function(a){return a.data.items},this)},_get:function(a){var b=c.create();return this.__calendar.events.get({auth:this.__google,calendarId:this.__calendarId,eventId:a},b.asyncCallbackFunc()),b},_remove:function(a){var b=c.create();return this.__calendar.events["delete"]({auth:this.__google,calendarId:this.__calendarId,eventId:a},b.asyncCallbackFunc()),b},_update:function(a,b){return c.value(b)},_insert:function(a){var b=c.create();return this.__calendar.events.quickAdd({auth:this.__google,calendarId:this.__calendarId,text:a.value},b.asyncCallbackFunc()),b.mapSuccess(function(b){return{id:b.eventId,value:a.value,start_date_utc:e.now(),start_date_utc_time_difference:null}})}}})}),a.define("module:Stores.GoogleCalendarStore",["data:Stores.TransformationStore","data:Queries","module:Stores.GoogleRawCalendarStore","base:Objs","base:Strings"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(b,d){a.constructor.call(this,new c(b,d),{destroy_store:!0})},_query_capabilities:function(){var b=a._query_capabilities.call(this);return b.sort=!0,b},_encodeData:function(a){var b={};return d.iter(a,function(a,c){"date"==c?b.Date=a:b[c]=a},this),b},_decodeData:function(a){if(a.value)return a;var b={id:a.id,value:a.summary,start_date_utc:null,start_date_utc_time_difference:null};if(a.start&&a.start.dateTime){var c=e.last_after(a.start.dateTime,"-").split(":");b.start_date_utc=new Date(a.start.dateTime).getTime(),b.start_date_utc_time_difference=60*parseInt(c[0],10)+parseInt(c[1],10)}return b},_encodeQuery:function(a,b){function c(a){d.iter(a,function(a,b){switch(b){case"start_date_utc":var d=a.$gte||a.$gt,f=a.$lte||a.$lt;d&&(e.timeMin=new Date(d).toISOString()),f&&(e.timeMax=new Date(f).toISOString());break;case"value":e.q=a;break;default:c(a)}})}var e={};return c(a),{query:e,options:b}}}})}),a.define("module:Stores.GoogleContactsStore",["data:Stores.BaseStore","data:Queries","base:Promise","base:Objs","base:Strings"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(b){a.constructor.call(this),this.__contacts=new(require("google-contacts").GoogleContacts)({token:b.credentials.access_token}),this.__google=b},_query_capabilities:function(){return{limit:!0,skip:!1,sort:!0,query:b.fullQueryCapabilities()}},_query:function(a,b){if(a.id)return this.get(a.id).mapSuccess(function(a){return[a]});b=b||{};var d=c.create();return this.__contacts.getContacts(d.asyncCallbackFunc(),{projection:"full","max-results":b.limit,q:[a.name||"",a.email||""].join(" ")}),d.mapSuccess(function(a){return a.map(this._decodePerson,this)},this)},_get:function(a){var b=c.create();return this.__contacts.getContact(b.asyncCallbackFunc(),{id:a}),b.mapSuccess(this._decodePerson,this)},_decodePerson:function(a){return a=a.entry||a,{id:a.id,name:a.name,email:a.email?a.email.toLowerCase():"",phoneNumber:a.phoneNumber}}}})}),a.define("module:Stores.GoogleRawMailStore",["data:Stores.BaseStore","data:Queries","base:Promise","base:Objs","base:Time","base:Types"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},function(a){return{constructor:function(b){a.constructor.call(this),this.__gmail=require("googleapis").google.gmail("v1"),this.__google=b},_query_capabilities:function(){return{limit:!0,skip:!1,sort:!0,query:{atom:!0,conditions:{$ct:!0,$ctic:!0,$sw:!0,$swic:!0}}}},__gmailExecute:function(a,b,e,f){return c.resilience(function(){var f=c.create(),g=this.__gmail.users;return b.split(".").forEach(function(a){g=g[a]}),g[a](d.extend({auth:this.__google,userId:"me"},e),f.asyncCallbackFunc()),f},this,f||5)},__isDraft:function(a){return 0===a.indexOf("r")},_get:function(a){var b=this.__isDraft(a);return this.__gmailExecute("get",b?"drafts":"messages",{id:a,format:"full"}).mapSuccess(function(c){var d=b?c.data.message:c.data;return d.id=a,d})},getAttachment:function(a,b){return this.__gmailExecute("get","messages.attachments",{messageId:a,id:b})},__rawMessageByData:function(a){var b=require("mailcomposer"),e=d.filter({to:a.to,cc:a.cc,bcc:a.bcc,"in-reply-to":a["In-Reply-To"],references:a.References,subject:a.subject,text:a.text_body,attachments:a.attachments},function(a){return!!a}),f=b(e),g=c.create();return f.build(function(a,b){g.asyncSuccess(b.toString("base64").replace(/\+/g,"-").replace(/\//g,"_"))}),g},_insert:function(a){var b=a.draft;return a.threadId&&a.threadId.indexOf("-")>=0&&delete a.threadId,this.__rawMessageByData(a).mapSuccess(function(c){return this.__gmailExecute(b?"create":"send",b?"drafts":"messages",{resource:b?{message:{threadId:a.threadId,raw:c}}:{threadId:a.threadId,raw:c}}).mapSuccess(function(a){return this.get(a.data.id)},this)},this)},_query:function(a,b){if(a.id)return this.get(a.id).mapSuccess(function(a){return[a.data||a]});var e=null;if(a.threadId)e=this.__gmailExecute("get","threads",{id:a.threadId,maxResults:b.limit||100});else{var g=[];d.iter(a,function(a,b){f.is_object(a)?d.iter(a,function(a,c){"$ct"!==c&&"$ctic"!==c||g.push(b+":*"+a+"*"),"$sw"!==c&&"$swic"!==c||g.push(b+":"+a+"*")}):"sent"!==b&&"in_inbox"!==b&&"draft"!==b&&"starred"!==b&&"archived"!==b&&g.push(b+":"+a)});var h=[];a.in_inbox&&h.push("INBOX"),"archived"in a&&!a.archived&&h.push("INBOX"),a.sent&&h.push("SENT"),a.draft&&h.push("DRAFT"),a.starred&&h.push("STARRED");var i={maxResults:b.limit||100};h.length>0&&(i.labelIds=h),g.length>0&&(i.q=g.join(" ")),e=this.__gmailExecute("list","messages",i)}return e.mapSuccess(function(a){var b=c.and();d.iter(a.data.messages,function(a){b=b.and(this.get(a.id))},this);var e=b.end();return this.__allDrafts().mapError(function(){return e}).mapSuccess(function(a){var b={};return a.forEach(function(a){b[a.message.id]=a.id}),e.mapSuccess(function(a){return a.map(function(a){return b[a.id]&&(a.id=b[a.id]),a})})})},this)},_remove:function(a){return this.__gmailExecute("delete","messages",{id:a,format:"full"})},__allDrafts:function(){return this.__gmailExecute("list","drafts",{}).mapSuccess(function(a){return a.data.drafts||[]})},__draftByMsgId:function(a){return this.__allDrafts().mapSuccess(function(b){for(var d=0;d<b.length;++d)if(b[d].message.id===a)return b[d];return c.error("Not found")},this)},__draftByDraftId:function(a){return this.__gmailExecute("list","drafts",{}).mapSuccess(function(b){for(var d=0;d<b.data.drafts.length;++d)if(b.data.drafts[d].id===a)return b.data.drafts[d];return c.error("Not found")},this)},_update:function(a,b){if(b.threadId&&b.threadId.indexOf("-")>=0&&delete b.threadId,"draft"in b&&!b.draft)return d.count(b)>1?(delete b.draft,this._update(a,b).mapSuccess(function(){return this._update(a,{draft:!1})},this)):this.__draftByDraftId(a).mapSuccess(function(a){return this.__gmailExecute("send","drafts",{resource:{id:a.id,message:a.message}}).mapSuccess(function(a){return this.get(a.data.id)},this)},this);if(this.__isDraft(a))return this._get(a).mapSuccess(function(e){if(d.iter(e.payload.headers,function(a){a.name.toLowerCase()in b||(b[a.name.toLowerCase()]=a.value)}),!("text_body"in b)&&e.payload.body&&e.payload.body.data){var f=new Buffer(e.payload.body.data,"base64");b.text_body=f.toString()}if(b.attachments)b.addAttachments=b.attachments,b.attachments=[];else{b.attachments=[];var g=function(a){d.iter(a,function(a){try{switch(a.mimeType){case"text/plain":"text_body"in b||(b.text_body=new Buffer(a.body.data,"base64").toString());break;case"text/html":break;case"multipart/alternative":g(a.parts);break;default:a.body&&a.body.attachmentId&&b.attachments.push({type:a.mimeType,name:a.filename,id:a.body.attachmentId})}}catch(c){}})};g(e.payload.parts||[e.payload])}return c.and(b.attachments.map(function(b){return this.getAttachment(a,b.id).mapSuccess(function(a){return{contentType:b.type,filename:b.name,content:new Buffer(a.data.data,"base64")}})},this)).end().mapSuccess(function(c){return b.attachments=c,b.attachmentsAdd&&(b.attachments=b.attachments.concat(b.attachmentsAdd.map(function(a){return{filename:a.name,content:a.data}})),delete b.attachmentsAdd),this.__rawMessageByData(d.extend(e,b)).mapSuccess(function(b){return this.__gmailExecute("update","drafts",{id:a,resource:{message:{raw:b}}}).mapSuccess(function(a){return this.get(a.data.id)},this)},this)},this)},this);var e=[],f=[];return"in_inbox"in b&&(b.in_inbox?e:f).push("INBOX"),"archived"in b&&(b.archived?f:e).push("INBOX"),"read"in b&&(b.read?f:e).push("UNREAD"),"starred"in b&&(b.starred?e:f).push("STARRED"),e.length+f.length>0?this.__gmailExecute("modify","messages",{id:a,resource:{addLabelIds:e,removeLabelIds:f}}):c.value({})}}})}),a.define("module:Stores.GoogleMailStore",["data:Stores.TransformationStore","data:Queries","module:Stores.GoogleRawMailStore","base:Objs","base:Promise"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(b){a.constructor.call(this,new c(b),{destroy_store:!0})},_query_capabilities:function(){var b=a._query_capabilities.call(this);return b.sort=!0,b},getAttachment:function(a,b){return this._store().getAttachment(a,b)},addAttachments:function(a,b){return this.update(a,{attachmentsAdd:b}).mapSuccess(function(a){return a.attachments.slice(-b.length)})},_encodeData:function(a){var b={labelIds:[]};return d.iter(a,function(a,c){if(null!==a&&a!==undefined)switch(c){case"time":b.Date=a;break;case"threadid":b.threadId=a;break;case"in_reply_to":b["In-Reply-To"]=a;break;case"to":case"cc":case"bcc":b[c]=a.join?a.join(","):a;break;case"references":b.References=a;break;default:b[c]=a}},this),0===b.labelIds.length&&delete b.labelIds,b},_decodeData:function(a){if(!a.payload)return a;var b={id:a.id,threadid:a.threadId,snippet:a.snippet,archived:!d.contains_value(a.labelIds,"INBOX"),attachments:[],to:[],cc:[],in_inbox:d.contains_value(a.labelIds,"INBOX"),read:!d.contains_value(a.labelIds,"UNREAD"),sent:d.contains_value(a.labelIds,"SENT"),draft:d.contains_value(a.labelIds,"DRAFT"),starred:d.contains_value(a.labelIds,"STARRED")};d.iter(a.labelIds,function(a){0===a.indexOf("CATEGORY_")&&(b.category=a.substring("CATEGORY_".length).toLowerCase())}),d.iter(a.payload.headers,function(a){switch(a.name){case"To":b.to.push(a.value);break;case"Cc":b.cc.push(a.value);break;case"From":b.from=a.value;break;case"Subject":b.subject=a.value;break;case"Date":b.creation_time=Date.parse(a.value);break;case"Message-Id":b.messageid=a.value}});var c=function(a){d.iter(a,function(a){try{switch(a.mimeType){case"text/plain":b.text_body=new Buffer(a.body.data,"base64").toString();break;case"text/html":b.html_body=new Buffer(a.body.data,"base64").toString();break;case"multipart/alternative":c(a.parts);break;default:a.body&&a.body.attachmentId&&b.attachments.push({type:a.mimeType,filename:a.filename,id:a.body.attachmentId,size:a.body.size,internal:!!b.html_body&&b.html_body.indexOf("cid:"+a.filename)>=0})}}catch(d){}})};return c(a.payload.parts||[a.payload]),b}}})}),a.define("module:Stores.GooglePeopleStore",["data:Stores.BaseStore","data:Queries","base:Promise","base:Objs","base:Strings"],function(a,b,c,d,e,f){var g=["addresses","ageRanges","biographies","birthdays","braggingRights","coverPhotos","emailAddresses","events","genders","imClients","interests","locales","memberships","metadata","names","nicknames","occupations","organizations","phoneNumbers","photos","relations","relationshipInterests","relationshipStatuses","residences","skills","taglines","urls"];return a.extend({scoped:f},function(a){return{constructor:function(b){a.constructor.call(this),this.__people=require("googleapis").google.people("v1"),this.__google=b},_query_capabilities:function(){return{limit:!0,skip:!1,sort:!0,query:b.fullQueryCapabilities()}},_query:function(a,b){if(a.id)return this.get(a.id).mapSuccess(function(a){return[a]});var e=c.create();return this.__people.contactGroups.get(d.extend({auth:this.__google,resourceName:"contactGroups/all",maxMembers:b.limit||100},a),e.asyncCallbackFunc()),e.mapSuccess(function(a){var b=c.create();return this.__people.people.getBatchGet({auth:this.__google,resourceNames:a.data.memberResourceNames||[],personFields:g},b.asyncCallbackFunc()),b.mapSuccess(function(a){return a.data.responses.filter(function(a){return 200===a.httpStatusCode}).map(this._decodePerson,this)},this)},this)},_get:function(a){var b=c.create();return this.__people.people.get({auth:this.__google,resourceName:this._encodePersonId(a),personFields:g},b.asyncCallbackFunc()),b.mapSuccess(this._decodePerson,this)},_encodePersonId:function(a){return"people/"+e.strip_start(a,"people/")},_decodePersonId:function(a){return e.strip_start(a,"people/")},_decodePerson:function(a){var b=a.person||a,c={id:this._decodePersonId(b.resourceName),emailAddresses:(b.emailAddresses||[]).map(function(a){return a.value.toLowerCase()}).filter(function(a){return e.is_email_address(a)}),gender:b.genders?b.genders[0].value:undefined,displayName:b.names?b.names[0].displayName:undefined,familyName:b.names?b.names[0].familyName:undefined,givenName:b.names?b.names[0].givenName:undefined,organization:b.organizations?b.organizations[0].name:undefined,title:b.organizations?b.organizations[0].title:undefined,photos:(b.photos||[]).map(function(a){return a.url}).filter(function(a){return!!a})};return c.name=c.displayName,c.email=c.emailAddresses[0],c}}})}),a.define("module:Stores.ImapStore",["data:Stores.BaseStore","data:Stores.StoreException","base:Objs","module:Net.Imap","module:Net.Smtp"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(b){a.constructor.call(this,b),this.__imap=c.extend(c.clone(b.base,1),b.imap),this.__smtp=c.extend(c.clone(b.base,1),b.smtp),this.__imap_opts=b.imap_options||{},this.__imap_opts.reconnect_on_error=!1},test:function(){var a=new d(this.__imap,this.__imap_opts);return a.connect().callback(a.destroy,a)},_query_capabilities:function(){return{skip:!0,limit:!0}},_query:function(a,b){var c=new d(this.__imap,this.__imap_opts);return c.connect().mapSuccess(function(){var a={};return"skip"in b&&(a.seq_start=b.skip+1),"limit"in b&&(a.seq_count=b.limit),a.reverse=!0,c.fetch(a).success(function(a){c.destroy()},this)},this)},_insert:function(a){e.send(this.__smtp,{from:a.from,to:a.to,subject:a.subject,text_body:a.text_body}).mapCallback(function(c,d){return c?new b(c):(a.id=d.header["message-id"],a)})}}})})}).call(Scoped);