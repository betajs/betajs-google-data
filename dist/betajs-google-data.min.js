/*!
betajs-google-data - v0.0.11 - 2020-07-15
Copyright (c) Oliver Friedmann
Apache-2.0 Software License.
*/

var Scoped=function(){var p=function(){return{get:function(e){return"undefined"!=typeof window?e?window[e]:window:"undefined"!=typeof global?e?global[e]:global:"undefined"!=typeof self?e?self[e]:self:undefined},set:function(e,t){return"undefined"!=typeof window&&(window[e]=t),"undefined"!=typeof global&&(global[e]=t),"undefined"!=typeof self&&(self[e]=t),t},getPath:function(e){if(!e)return this.get();var t=e.split(".");if(1==t.length)return this.get(e);for(var n=this.get(t[0]),a=1;a<t.length;++a){if(!n)return n;n=n[t[a]]}return n},setPath:function(e,t){var n=e.split(".");if(1==n.length)return this.set(e,t);for(var a=this.get(n[0])||this.set(n[0],{}),r=1;r<n.length-1;++r)n[r]in a||(a[n[r]]={}),a=a[n[r]];return a[n[n.length-1]]=t}}}.call(this),f=function(){return{method:function(e,t){return function(){return t.apply(e,arguments)}},extend:function(e,t){for(var n in e=e||{},t=t||{})e[n]=t[n];return e},typeOf:function(e){return"[object Array]"===Object.prototype.toString.call(e)?"array":typeof e},isEmpty:function(e){if(null==e)return!0;if("array"==this.typeOf(e))return 0===e.length;if("object"!=typeof e)return!1;for(var t in e)return!1;return!0},matchArgs:function(e,t){var n=0,a={};for(var r in t)!0===t[r]||this.typeOf(e[n])==t[r]?(a[r]=e[n],n++):"undefined"==this.typeOf(e[n])&&n++;return a},stringify:function(e){return"function"==this.typeOf(e)?""+e:JSON.stringify(e)}}}.call(this),s=function(){return{__namespace:"Scoped",__revert:null,upgrade:function(e){var t=p.get(e||s.__namespace);if(t&&"object"===f.typeOf(t)&&t.guid===this.guid&&"string"===f.typeOf(t.version)){if(!1===this.upgradable||!1===t.upgradable)return t;for(var n=this.version.split("."),a=t.version.split("."),r=!1,i=0;i<Math.min(n.length,a.length)&&(r=parseInt(n[i],10)>parseInt(a[i],10),n[i]===a[i]);++i);return r?this.attach(e):t}return this.attach(e)},attach:function(e){e&&(s.__namespace=e);var t=p.get(s.__namespace);if(t===this)return this;if(s.__revert=t)try{var n=t.__exportScoped();this.__exportBackup=this.__exportScoped(),this.__importScoped(n)}catch(a){}return p.set(s.__namespace,this),this},detach:function(e){return e&&p.set(s.__namespace,null),"undefined"!=typeof s.__revert&&p.set(s.__namespace,s.__revert),delete s.__revert,s.__exportBackup&&this.__importScoped(s.__exportBackup),this},exports:function(e,t,n){return"object"==typeof(e=e||("undefined"!=typeof module?module:null))&&e&&"exports"in e&&(n||e.exports===this||!e.exports||f.isEmpty(e.exports))&&(e.exports=t||this),this}}}.call(this);function _(e){var s={tree:"boolean"==typeof e.tree&&e.tree,global:"boolean"==typeof e.global&&e.global,root:"object"==typeof e.root?e.root:{}};function r(e){return{route:"string"==typeof e.route?e.route:null,parent:"object"==typeof e.parent?e.parent:null,ready:"boolean"==typeof e.ready&&e.ready,children:{},watchers:[],data:{},lazy:[]}}var o=r({ready:!0});if(s.tree)if(s.global){try{window&&(o.data=window)}catch(t){}try{global&&(o.data=global)}catch(t){}try{self&&(o.data=self)}catch(t){}}else o.data=s.root;function c(e){if(!e.ready)if(!e.parent||e.parent.ready){if(e.route&&e.parent&&e.route in e.parent.data){e.data=e.parent.data[e.route],e.ready=!0;for(var t=0;t<e.watchers.length;++t)e.watchers[t].callback.call(e.watchers[t].context||this,e.data);for(var n in e.watchers=[],e.children)c(e.children[n])}}else c(e.parent)}function a(e,t){if("object"==typeof t&&e.ready)for(var n in t)e.data[n]=t[n];else e.data=t;if("object"==typeof t)for(var a in t)e.children[a]&&(e.children[a].data=t[a]);for(var r in!function i(e){if(!e.ready){e.parent&&!e.parent.ready&&i(e.parent),e.ready=!0,e.parent&&s.tree&&"object"==typeof e.parent.data&&(e.parent.data[e.route]=e.data);for(var t=0;t<e.watchers.length;++t)e.watchers[t].callback.call(e.watchers[t].context||this,e.data);e.watchers=[]}}(e),e.children)c(e.children[r])}function u(e){if(!e)return o;for(var t=e.split("."),n=o,a=0;a<t.length;++a)t[a]in n.children?n=n.children[t[a]]:(n.children[t[a]]=r({parent:n,route:t[a]}),c(n=n.children[t[a]]));return n}return{extend:function(e,t){a(u(e),t)},set:function(e,t){var n=u(e);n.data&&function(e){if(e.ready&&e.data)for(var t in e.data)delete e.data[t]}(n),a(n,t)},get:function(e){var t=u(e);return t.ready?t.data:null},lazy:function(e,t,n){var a=u(e);a.ready?t(n||this,a.data):a.lazy.push({callback:t,context:n})},digest:function(e){c(u(e))},obtain:function(e,t,n){!function(e,t,n){var a;e.ready?t.call(n||this,e.data):(e.watchers.push({callback:t,context:n}),0<e.lazy.length&&(a=function(e){var t;0<e.lazy.length&&((t=e.lazy.shift()).callback.call(t.context||this,e.data),a(e))})(e))}(u(e),t,n)},unresolvedWatchers:function(e){return function i(e,t,n){for(var a in n=n||[],!(e=e||o).ready&&0===e.lazy.length&&0<e.watchers.length&&n.push(t),e.children){var r=e.children[a];n=i(r,(t?t+".":"")+r.route,n)}return n}(u(e),e)},__export:function(){return{options:s,nsRoot:o}},__import:function(e){s=e.options,o=e.nsRoot}}}var t=_({tree:!0,global:!0}),n=_({tree:!0}),a=function m(e,t,n,a){var r=null,i=[],s=t,o=n,c=a,u=_({tree:!0}),d=_({tree:!1}),l={global:{namespace:c},root:{namespace:o},local:{namespace:u},"default":{namespace:d},parent:{namespace:s},scope:{namespace:u,readonly:!1}},h=function(i,s,o){var c=f.matchArgs(i,{options:"object",namespaceLocator:!0,dependencies:"array",hiddenDependencies:"array",callback:!0,context:"object"}),e=f.extend({lazy:this.options.lazy},c.options||{}),u=this.resolve(c.namespaceLocator),t=function(){this.require(c.dependencies,c.hiddenDependencies,function(){for(var e=[],t=0;t<arguments.length;++t)e.push(arguments[t]);if(e[e.length-1].ns=u,this.options.compile){for(var n=[],a=0;a<i.length;++a)n.push(f.stringify(i[a]));this.compiled+=this.options.ident+"."+s+"("+n.join(", ")+");\n\n"}this.options.dependencies&&(this.dependencies[u.path]=this.dependencies[u.path]||{},c.dependencies&&c.dependencies.forEach(function(e){this.dependencies[u.path][this.resolve(e).path]=!0},this),c.hiddenDependencies&&c.hiddenDependencies.forEach(function(e){this.dependencies[u.path][this.resolve(e).path]=!0},this));var r=this.options.compile?{}:c.callback.apply(c.context||this,e);o.call(this,u,r)},this)};return e.lazy?u.namespace.lazy(u.path,t,this):t.apply(this),this};return{getGlobal:f.method(p,p.getPath),setGlobal:f.method(p,p.setPath),options:{lazy:!1,ident:"Scoped",compile:!1,dependencies:!1},compiled:"",dependencies:{},nextScope:function(){return r=r||m(0,u,o,c)},subScope:function(){var e=this.nextScope();return i.push(e),r=null,e},binding:function(e,t,n){var a;return l[e]&&l[e].readonly||(a="string"!=f.typeOf(t)?{namespace:_({tree:!0,root:t}),path:null}:this.resolve(t),l[e]=f.extend(n,a)),this},resolve:function(e){var t=e.split(":");if(1==t.length)throw"The locator '"+t[0]+"' requires a namespace.";var n=l[t[0]];if(!n)throw"The namespace '"+t[0]+"' has not been defined (yet).";return{namespace:n.namespace,path:n.path&&t[1]?n.path+"."+t[1]:n.path||t[1]}},define:function(){return h.call(this,arguments,"define",function(e,t){if(e.namespace.get(e.path))throw"Scoped namespace "+e.path+" has already been defined. Use extend to extend an existing namespace instead";e.namespace.set(e.path,t)})},assumeVersion:function(){var i=f.matchArgs(arguments,{assumption:!0,dependencies:"array",callback:!0,context:"object",error:"string"}),e=i.dependencies||[];e.unshift(i.assumption),this.require(e,function(){var e=arguments,t=e[0].replace(/[^\d\.]/g,"");e[0]=t.split(".");for(var n=0;n<e[0].length;++n)e[0][n]=parseInt(e[0][n],10);if("function"===f.typeOf(i.callback)){if(!i.callback.apply(i.context||this,i))throw"Scoped Assumption '"+i.assumption+"' failed, value is "+t+(i.error?", but assuming "+i.error:"")}else for(var a=(i.callback+"").replace(/[^\d\.]/g,"").split("."),r=0;r<Math.min(e[0].length,a.length);++r)if(parseInt(a[r],10)>e[0][r])throw"Scoped Version Assumption '"+i.assumption+"' failed, value is "+t+", but assuming at least "+i.callback})},extend:function(){return h.call(this,arguments,"extend",function(e,t){e.namespace.extend(e.path,t)})},require:function(){var t=f.matchArgs(arguments,{dependencies:"array",hiddenDependencies:"array",callback:"function",context:"object"});t.callback=t.callback||function(){};var e=t.dependencies||[],n=e.concat(t.hiddenDependencies||[]),a=n.length,r=[],i={};if(a)for(var s=function(e){this.i<r.length&&(r[this.i]=e),0==--a&&(r.push(i),t.callback.apply(t.context||this.ctx,r))},o=0;o<n.length;++o){var c=this.resolve(n[o]);o<e.length&&r.push(null),c.namespace.obtain(c.path,s,{ctx:this,i:o})}else r.push(i),t.callback.apply(t.context||this,r);return this},digest:function(e){var t=this.resolve(e);return t.namespace.digest(t.path),this},unresolved:function(e){var t=this.resolve(e);return t.namespace.unresolvedWatchers(t.path)},__export:function(){return{parentNamespace:s.__export(),rootNamespace:o.__export(),globalNamespace:c.__export(),localNamespace:u.__export(),privateNamespace:d.__export()}},__import:function(e){s.__import(e.parentNamespace),o.__import(e.rootNamespace),c.__import(e.globalNamespace),u.__import(e.localNamespace),d.__import(e.privateNamespace)}}}(0,n,n,t),e=f.extend(a,function(){return{guid:"4b6878ee-cb6a-46b3-94ac-27d91f58d666",version:"0.0.22",upgradable:!0,upgrade:s.upgrade,attach:s.attach,detach:s.detach,exports:s.exports,__exportScoped:function(){return{globalNamespace:t.__export(),rootNamespace:n.__export(),rootScope:a.__export()}},__importScoped:function(e){t.__import(e.globalNamespace),n.__import(e.rootNamespace),a.__import(e.rootScope)}}}.call(this));return(e=e.upgrade()).exports(),e}.call(this);(function(){var e=this.subScope();e.binding("module","global:BetaJS.Data.Google"),e.binding("base","global:BetaJS"),e.binding("data","global:BetaJS.Data"),e.define("module:",function(){return{guid:"40dfb24a-cf2c-4992-bf16-725d5177b5c9",version:"0.0.11",datetime:1594837995064}}),e.assumeVersion("base:version","~1.0.96"),e.assumeVersion("data:version","~1.0.41"),e.define("module:Helpers.Google",["base:Promise","base:Time"],function(a,t){var r=require("googleapis"),i=require("@google-cloud/pubsub");return{getUserProfile:function(e){var t=a.create();return r.google.gmail("v1").users.getProfile({auth:e,userId:"me"},t.asyncCallbackFunc()),t.mapSuccess(function(e){return e.data})},oauth2:function(e,t,n){return new r.google.auth.OAuth2(e,t,n)},oauth2WithCredentials:function(e,t,n){var a=this.oauth2(e,t);return a.setCredentials(n),a},oauth2RefreshRequired:function(e){return e.credentials.expiry_date<t.now()},oauth2ForceRefresh:function(e){var t=a.create();return e.refreshAccessToken(t.asyncCallbackFunc()),t},oauth2EnsureRefreshed:function(e){return this.oauth2RefreshRequired(oauth)?this.oauth2ForceRefresh(e):a.value(!0)},oauth2GetToken:function(e,t){var n=a.create();return e.getToken(t,n.asyncCallbackFunc()),n},oauth2Url:function(e,t){return e.generateAuthUrl({access_type:"offline",prompt:"consent",scope:t})},gmailWatch:function(e,t){var n=a.create();return r.google.gmail("v1").users.watch({userId:"me",auth:e,resource:{labelIds:["INBOX"],topicName:"projects/"+t.project_id+"/topics/"+t.topic_name}},n.asyncCallbackFunc()),n},pubsubSubscribe:function(e,n,a){var t=new i({projectId:e.project_id,credentials:{private_key:e.private_key,client_email:e.client_email}}),r="projects/"+e.project_id+"/subscriptions/"+e.subscription_name;t.subscription(r).on("message",function(e){try{n.call(a,e.id,JSON.parse(e.data),e.attributes)}catch(t){console.log(t)}e.ack()})}}}),e.define("module:Net.Imap",["base:Class","base:Events.EventsMixin","base:Objs","base:Async","base:Promise","base:Types"],function(e,t,o,r,n,c,a){return e.extend({scoped:a},[t,function(a){return{constructor:function(e,t){a.constructor.call(this),this.__quoted_printable=require("quoted-printable"),this.__html_strip=require("string-strip-html"),this.__auth=e,t=t||{},this.__options=t,this.__count=0,this.__Imap=require("imap"),this.__connected=!1,this.__imap=new this.__Imap(o.extend({tls:!0,tlsOptions:{rejectUnauthorized:!1}},e));var n=this;this.__imap.on("mail",function(e){n.__count+=e}),this.__imap.on("error",function(){n.trigger("error"),t.reconnect_on_error&&r.eventually(n.reconnect,[],n)})},destroy:function(){this.disconnect(),a.destroy.call(this)},connect:function(){if(this.__connected)return n.value(!0);this.__count=0;var r=this,i=n.create(),s=function(){i.error(!0),r.off("error",s)};return this.on("error",s),this.__imap.connect(),this.__imap.once("ready",function(){r.__connected=!0;var t=r.__options.mailbox||"INBOX";c.is_array(t)||(t=[t]),t=o.clone(t,1);var n=null,a=function(){0===t.length&&(i.error(n),r.__connected=!1);var e=t.shift();r.__imap.openBox(e,!0,function(e,t){return e?(n=e,void a()):(r.on("error",s),r.__imap.on("mail",function(e){r.trigger("new_mail",e)}),void i.asyncSuccess(!0))})};r.off("error",s),a()}),i},disconnect:function(){this.__connected&&(this.__imap.end(),this.__connected=!1)},reconnect:function(){this.disconnect(),this.connect()},count:function(){return this.__count},fetch:function(e,t){var n=[];"headers"in(e=e||{})&&!e.headers||n.push("HEADER.FIELDS (FROM TO SUBJECT DATE)"),"body"in e&&!e.body||n.push("TEXT");var a,r=1,i=100;e.seq_count?e.seq_end?r=(i=e.seq_end)-e.seq_count+1:i=(r=e.seq_start||r)+e.seq_count-1:(r=e.seq_start||r,i=e.seq_end||r+99),e.reverse&&(a=i-r,r=(i=this.__count-r+1)-a);var s=this.__imap.seq.fetch(r+":"+i,{bodies:n,struct:!0});return this.__query(s)},__query:function(e){var s=this,o=[];e.on("message",function(e,n){var a={},r="",i="";e.on("body",function(e,t){e.on("data",function(e){"TEXT"===t.which?i+=e.toString("utf8"):r+=e.toString("utf8")})}),e.once("attributes",function(e){a=e}),e.once("end",function(){a.seqno=n;try{var e=s.__parse(s.__Imap.parseHeader(r),i,a);e&&o.push(e)}catch(t){}})});var t=n.create();return e.once("error",function(e){t.asyncError(e)}),e.once("end",function(){t.asyncSuccess(o)}),t},__parse:function(e,t,n){this.trigger("parse",e,t,n);var a,r={};if(r.uid=n.uid,r.threadid=n["x-gm-thrid"],r.id=n.uid,r.seqid=n.seqno,e&&e.subject&&0<e.subject.length&&(r.subject=e.subject[0]),e&&e.to&&0<e.to.length&&(r.to=e.to[0]),e&&e.from&&0<e.from.length&&(r.from=e.from[0]),e&&e.date&&0<e.date.length&&(a=new Date(e.date[0]),r.time=a.getTime()),t){var i=n.struct,s=[];if(1<i.length)for(var o=i[0].params.boundary,c=(d=t).indexOf(o),u=1;u<i.length;++u){var d,l,h=i[u][0]||{};d=(d=d.substring(d.indexOf(o)+o.length)).substring(d.indexOf("\r\n\r\n")+"\r\n\r\n".length),h.disposition||"text"!==h.type||(l=d.indexOf(o)-c,s.push({meta:h,body:0<=l?d.substring(0,l):d}))}else s.push({meta:i[0],body:t});for(var p=null,f=null,_=0;_<s.length;++_){var m=s[_].body,g=s[_].meta.encoding.toLowerCase();try{m="quoted-printable"===g?this.__quoted_printable.decode(m).toString():new Buffer(m,g).toString()}catch(b){}"html"===s[_].meta.subtype?p=m:f=m}!f&&p&&(f=this.__html_strip(p)),r.html_body=p,r.text_body=f}return r}}}])}),e.define("module:Net.Smtp",["base:Strings","base:Promise"],function(r,i){return{send:function(e,t){var n=require("emailjs");t.from=r.email_get_email(t.from),t.to=r.email_get_email(t.to),t.text_body&&(t.text=t.text_body,delete t.text_body);var a=i.create();return n.server.connect(e).send(n.message.create(t),a.asyncCallbackFunc()),a}}}),e.define("module:Stores.GoogleRawCalendarStore",["data:Stores.BaseStore","data:Queries","base:Promise","base:Objs","base:Time"],function(e,t,r,i,a,n){return e.extend({scoped:n},function(n){return{constructor:function(e,t){n.constructor.call(this),this.__calendar=require("googleapis").google.calendar("v3"),this.__google=e,this.__calendarId=t},_query_capabilities:function(){return{limit:!0,skip:!1,sort:!0,query:t.fullQueryCapabilities()}},_query:function(e,t){if(e.id)return this.get(e.id).mapSuccess(function(e){return[e]});var n=r.create(),a=i.extend({auth:this.__google,calendarId:this.__calendarId,maxResults:t.limit||100,singleEvents:!0,timeZone:"UTC"},e);return this.__calendar.events.list(a,n.asyncCallbackFunc()),n.mapSuccess(function(e){return e.data.items},this)},_get:function(e){var t=r.create();return this.__calendar.events.get({auth:this.__google,calendarId:this.__calendarId,eventId:e},t.asyncCallbackFunc()),t},_remove:function(e){var t=r.create();return this.__calendar.events["delete"]({auth:this.__google,calendarId:this.__calendarId,eventId:e},t.asyncCallbackFunc()),t},_update:function(e,t){return r.value(t)},_insert:function(t){var e=r.create();return this.__calendar.events.quickAdd({auth:this.__google,calendarId:this.__calendarId,text:t.value},e.asyncCallbackFunc()),e.mapSuccess(function(e){return{id:e.eventId,value:t.value,start_date_utc:a.now(),start_date_utc_time_difference:null}})}}})}),e.define("module:Stores.GoogleCalendarStore",["data:Stores.TransformationStore","data:Queries","module:Stores.GoogleRawCalendarStore","base:Objs","base:Strings"],function(e,t,a,s,r,n){return e.extend({scoped:n},function(n){return{constructor:function(e,t){n.constructor.call(this,new a(e,t),{destroy_store:!0})},_query_capabilities:function(){var e=n._query_capabilities.call(this);return e.sort=!0,e},_encodeData:function(e){var n={};return s.iter(e,function(e,t){"date"==t?n.Date=e:n[t]=e},this),n},_decodeData:function(e){if(e.value)return e;var t,n={id:e.id,value:e.summary,start_date_utc:null,start_date_utc_time_difference:null};return e.start&&e.start.dateTime&&(t=r.last_after(e.start.dateTime,"-").split(":"),n.start_date_utc=new Date(e.start.dateTime).getTime(),n.start_date_utc_time_difference=60*parseInt(t[0],10)+parseInt(t[1],10)),n},_encodeQuery:function(e,t){var r={};return function i(e){s.iter(e,function(e,t){switch(t){case"start_date_utc":var n=e.$gte||e.$gt,a=e.$lte||e.$lt;n&&(r.timeMin=new Date(n).toISOString()),a&&(r.timeMax=new Date(a).toISOString());break;case"value":r.q=e;break;default:i(e)}})}(e),{query:r,options:t}}}})}),e.define("module:Stores.GoogleContactsStore",["data:Stores.BaseStore","data:Queries","base:Promise","base:Objs","base:Strings"],function(e,n,a,t,r,i){return e.extend({scoped:i},function(t){return{constructor:function(e){t.constructor.call(this),this.__contacts=new(require("google-contacts").GoogleContacts)({token:e.credentials.access_token}),this.__google=e},_query_capabilities:function(){return{limit:!0,skip:!1,sort:!0,query:n.fullQueryCapabilities()}},_query:function(e,t){if(e.id)return this.get(e.id).mapSuccess(function(e){return[e]});t=t||{};var n=a.create();return this.__contacts.getContacts(n.asyncCallbackFunc(),{projection:"full","max-results":t.limit,q:[e.name||"",e.email||""].join(" ")}),n.mapSuccess(function(e){return e.map(this._decodePerson,this)},this)},_get:function(e){var t=a.create();return this.__contacts.getContact(t.asyncCallbackFunc(),{id:e}),t.mapSuccess(this._decodePerson,this)},_decodePerson:function(e){return{id:(e=e.entry||e).id,name:e.name,email:e.email?e.email.toLowerCase():"",phoneNumber:e.phoneNumber}}}})}),e.define("module:Stores.GoogleRawMailStore",["data:Stores.BaseStore","data:Queries","base:Promise","base:Objs","base:Time","base:Types"],function(e,t,i,s,n,o,a){return e.extend({scoped:a},function(t){return{constructor:function(e){t.constructor.call(this),this.__gmail=require("googleapis").google.gmail("v1"),this.__google=e},_query_capabilities:function(){return{limit:!0,skip:!1,sort:!0,query:{atom:!0,conditions:{$ct:!0,$ctic:!0,$sw:!0,$swic:!0}}}},__gmailExecute:function(n,a,r,e){return i.resilience(function(){var e=i.create(),t=this.__gmail.users;return a.split(".").forEach(function(e){t=t[e]}),t[n](s.extend({auth:this.__google,userId:"me"},r),e.asyncCallbackFunc()),e},this,e||5)},__isDraft:function(e){return 0===e.indexOf("r")},_get:function(n){var a=this.__isDraft(n);return this.__gmailExecute("get",a?"drafts":"messages",{id:n,format:"full"}).mapSuccess(function(e){var t=a?e.data.message:e.data;return t.id=n,t})},getAttachment:function(e,t){return this.__gmailExecute("get","messages.attachments",{messageId:e,id:t})},__rawMessageByData:function(e){var t=require("mailcomposer")(s.filter({to:e.to,cc:e.cc,bcc:e.bcc,"in-reply-to":e["In-Reply-To"],references:e.References,subject:e.subject,text:e.text_body,attachments:e.attachments},function(e){return!!e})),n=i.create();return t.build(function(e,t){n.asyncSuccess(t.toString("base64").replace(/\+/g,"-").replace(/\//g,"_"))}),n},_insert:function(t){var n=t.draft;return t.threadId&&0<=t.threadId.indexOf("-")&&delete t.threadId,this.__rawMessageByData(t).mapSuccess(function(e){return this.__gmailExecute(n?"create":"send",n?"drafts":"messages",{resource:n?{message:{threadId:t.threadId,raw:e}}:{threadId:t.threadId,raw:e}}).mapSuccess(function(e){return this.get(e.data.id)},this)},this)},_query:function(e,t){if(e.id)return this.get(e.id).mapSuccess(function(e){return[e.data||e]});var a,n,r;return(e.threadId?this.__gmailExecute("get","threads",{id:e.threadId,maxResults:t.limit||100}):(a=[],s.iter(e,function(e,n){o.is_object(e)?s.iter(e,function(e,t){"$ct"!==t&&"$ctic"!==t||a.push(n+":*"+e+"*"),"$sw"!==t&&"$swic"!==t||a.push(n+":"+e+"*")}):"sent"!==n&&"in_inbox"!==n&&"draft"!==n&&"starred"!==n&&"archived"!==n&&a.push(n+":"+e)}),n=[],e.in_inbox&&n.push("INBOX"),"archived"in e&&!e.archived&&n.push("INBOX"),e.sent&&n.push("SENT"),e.draft&&n.push("DRAFT"),e.starred&&n.push("STARRED"),r={maxResults:t.limit||100},0<n.length&&(r.labelIds=n),0<a.length&&(r.q=a.join(" ")),this.__gmailExecute("list","messages",r))).mapSuccess(function(e){var t=i.and();s.iter(e.data.messages,function(e){t=t.and(this.get(e.id))},this);var n=t.end();return this.__allDrafts().mapError(function(){return n}).mapSuccess(function(e){var t={};return e.forEach(function(e){t[e.message.id]=e.id}),n.mapSuccess(function(e){return e.map(function(e){return t[e.id]&&(e.id=t[e.id]),e})})})},this)},_remove:function(e){return this.__gmailExecute("delete","messages",{id:e,format:"full"})},__allDrafts:function(){return this.__gmailExecute("list","drafts",{}).mapSuccess(function(e){return e.data.drafts||[]})},__draftByMsgId:function(n){return this.__allDrafts().mapSuccess(function(e){for(var t=0;t<e.length;++t)if(e[t].message.id===n)return e[t];return i.error("Not found")},this)},__draftByDraftId:function(n){return this.__gmailExecute("list","drafts",{}).mapSuccess(function(e){for(var t=0;t<e.data.drafts.length;++t)if(e.data.drafts[t].id===n)return e.data.drafts[t];return i.error("Not found")},this)},_update:function(a,r){if(r.threadId&&0<=r.threadId.indexOf("-")&&delete r.threadId,"draft"in r&&!r.draft)return 1<s.count(r)?(delete r.draft,this._update(a,r).mapSuccess(function(){return this._update(a,{draft:!1})},this)):this.__draftByDraftId(a).mapSuccess(function(e){return this.__gmailExecute("send","drafts",{resource:{id:e.id,message:e.message}}).mapSuccess(function(e){return this.get(e.data.id)},this)},this);if(this.__isDraft(a))return this._get(a).mapSuccess(function(t){var e,n;return s.iter(t.payload.headers,function(e){e.name.toLowerCase()in r||(r[e.name.toLowerCase()]=e.value)}),"text_body"in r||!t.payload.body||!t.payload.body.data||(e=new Buffer(t.payload.body.data,"base64"),r.text_body=e.toString()),r.attachments?(r.addAttachments=r.attachments,r.attachments=[]):(r.attachments=[],(n=function(e){s.iter(e,function(e){try{switch(e.mimeType){case"text/plain":"text_body"in r||(r.text_body=new Buffer(e.body.data,"base64").toString());break;case"text/html":break;case"multipart/alternative":n(e.parts);break;default:e.body&&e.body.attachmentId&&r.attachments.push({type:e.mimeType,name:e.filename,id:e.body.attachmentId})}}catch(t){}})})(t.payload.parts||[t.payload])),i.and(r.attachments.map(function(t){return this.getAttachment(a,t.id).mapSuccess(function(e){return{contentType:t.type,filename:t.name,content:new Buffer(e.data.data,"base64")}})},this)).end().mapSuccess(function(e){return r.attachments=e,r.attachmentsAdd&&(r.attachments=r.attachments.concat(r.attachmentsAdd.map(function(e){return{filename:e.name,content:e.data}})),delete r.attachmentsAdd),this.__rawMessageByData(s.extend(t,r)).mapSuccess(function(e){return this.__gmailExecute("update","drafts",{id:a,resource:{message:{raw:e}}}).mapSuccess(function(e){return this.get(e.data.id)},this)},this)},this)},this);var e=[],t=[];return"in_inbox"in r&&(r.in_inbox?e:t).push("INBOX"),"archived"in r&&(r.archived?t:e).push("INBOX"),"read"in r&&(r.read?t:e).push("UNREAD"),"starred"in r&&(r.starred?e:t).push("STARRED"),0<e.length+t.length?this.__gmailExecute("modify","messages",{id:a,resource:{addLabelIds:e,removeLabelIds:t}}):i.value({})}}})}),e.define("module:Stores.GoogleMailStore",["data:Stores.TransformationStore","data:Queries","module:Stores.GoogleRawMailStore","base:Objs","base:Promise"],function(e,t,n,r,a,i){return e.extend({scoped:i},function(t){return{constructor:function(e){t.constructor.call(this,new n(e),{destroy_store:!0})},_query_capabilities:function(){var e=t._query_capabilities.call(this);return e.sort=!0,e},getAttachment:function(e,t){return this._store().getAttachment(e,t)},addAttachments:function(e,t){return this.update(e,{attachmentsAdd:t}).mapSuccess(function(e){return e.attachments.slice(-t.length)})},_encodeData:function(e){var n={labelIds:[]};return r.iter(e,function(e,t){if(null!==e&&e!==undefined)switch(t){case"time":n.Date=e;break;case"threadid":n.threadId=e;break;case"in_reply_to":n["In-Reply-To"]=e;break;case"to":case"cc":case"bcc":n[t]=e.join?e.join(","):e;break;case"references":n.References=e;break;default:n[t]=e}},this),0===n.labelIds.length&&delete n.labelIds,n},_decodeData:function(e){if(!e.payload)return e;var n={id:e.id,threadid:e.threadId,snippet:e.snippet,archived:!r.contains_value(e.labelIds,"INBOX"),attachments:[],to:[],cc:[],in_inbox:r.contains_value(e.labelIds,"INBOX"),read:!r.contains_value(e.labelIds,"UNREAD"),sent:r.contains_value(e.labelIds,"SENT"),draft:r.contains_value(e.labelIds,"DRAFT"),starred:r.contains_value(e.labelIds,"STARRED")};r.iter(e.labelIds,function(e){0===e.indexOf("CATEGORY_")&&(n.category=e.substring("CATEGORY_".length).toLowerCase())}),r.iter(e.payload.headers,function(e){switch(e.name){case"To":n.to.push(e.value);break;case"Cc":n.cc.push(e.value);break;case"From":n.from=e.value;break;case"Subject":n.subject=e.value;break;case"Date":n.creation_time=Date.parse(e.value);break;case"Message-Id":n.messageid=e.value}});var a=function(e){r.iter(e,function(e){try{switch(e.mimeType){case"text/plain":n.text_body=new Buffer(e.body.data,"base64").toString();break;case"text/html":n.html_body=new Buffer(e.body.data,"base64").toString();break;case"multipart/alternative":a(e.parts);break;default:e.body&&e.body.attachmentId&&n.attachments.push({type:e.mimeType,filename:e.filename,id:e.body.attachmentId,size:e.body.size,internal:!!n.html_body&&0<=n.html_body.indexOf("cid:"+e.filename)})}}catch(t){}})};return a(e.payload.parts||[e.payload]),n}}})}),e.define("module:Stores.GooglePeopleStore",["data:Stores.BaseStore","data:Queries","base:Promise","base:Objs","base:Strings"],function(e,n,a,r,i,t){var s=["addresses","ageRanges","biographies","birthdays","braggingRights","coverPhotos","emailAddresses","events","genders","imClients","interests","locales","memberships","metadata","names","nicknames","occupations","organizations","phoneNumbers","photos","relations","relationshipInterests","relationshipStatuses","residences","skills","taglines","urls"];return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this),this.__people=require("googleapis").google.people("v1"),this.__google=e},_query_capabilities:function(){return{limit:!0,skip:!1,sort:!0,query:n.fullQueryCapabilities()}},_query:function(e,t){if(e.id)return this.get(e.id).mapSuccess(function(e){return[e]});var n=a.create();return this.__people.contactGroups.get(r.extend({auth:this.__google,resourceName:"contactGroups/all",maxMembers:t.limit||100},e),n.asyncCallbackFunc()),n.mapSuccess(function(e){var t=a.create();return this.__people.people.getBatchGet({auth:this.__google,resourceNames:e.data.memberResourceNames||[],personFields:s},t.asyncCallbackFunc()),t.mapSuccess(function(e){return e.data.responses.filter(function(e){return 200===e.httpStatusCode}).map(this._decodePerson,this)},this)},this)},_get:function(e){var t=a.create();return this.__people.people.get({auth:this.__google,resourceName:this._encodePersonId(e),personFields:s},t.asyncCallbackFunc()),t.mapSuccess(this._decodePerson,this)},_encodePersonId:function(e){return"people/"+i.strip_start(e,"people/")},_decodePersonId:function(e){return i.strip_start(e,"people/")},_decodePerson:function(e){var t=e.person||e,n={id:this._decodePersonId(t.resourceName),emailAddresses:(t.emailAddresses||[]).map(function(e){return e.value.toLowerCase()}).filter(function(e){return i.is_email_address(e)}),gender:t.genders?t.genders[0].value:undefined,displayName:t.names?t.names[0].displayName:undefined,familyName:t.names?t.names[0].familyName:undefined,givenName:t.names?t.names[0].givenName:undefined,organization:t.organizations?t.organizations[0].name:undefined,title:t.organizations?t.organizations[0].title:undefined,photos:(t.photos||[]).map(function(e){return e.url}).filter(function(e){return!!e})};return n.name=n.displayName,n.email=n.emailAddresses[0],n}}})}),e.define("module:Stores.ImapStore",["data:Stores.BaseStore","data:Stores.StoreException","base:Objs","module:Net.Imap","module:Net.Smtp"],function(e,a,n,r,i,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this,e),this.__imap=n.extend(n.clone(e.base,1),e.imap),this.__smtp=n.extend(n.clone(e.base,1),e.smtp),this.__imap_opts=e.imap_options||{},this.__imap_opts.reconnect_on_error=!1},test:function(){var e=new r(this.__imap,this.__imap_opts);return e.connect().callback(e.destroy,e)},_query_capabilities:function(){return{skip:!0,limit:!0}},_query:function(e,t){var n=new r(this.__imap,this.__imap_opts);return n.connect().mapSuccess(function(){var e={};return"skip"in t&&(e.seq_start=t.skip+1),"limit"in t&&(e.seq_count=t.limit),e.reverse=!0,n.fetch(e).success(function(e){n.destroy()},this)},this)},_insert:function(n){i.send(this.__smtp,{from:n.from,to:n.to,subject:n.subject,text_body:n.text_body}).mapCallback(function(e,t){return e?new a(e):(n.id=t.header["message-id"],n)})}}})})}).call(Scoped);