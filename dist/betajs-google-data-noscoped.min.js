/*!
betajs-google-data - v0.0.14 - 2021-01-23
Copyright (c) Oliver Friedmann
Apache-2.0 Software License.
*/

(function(){var e=this.subScope();e.binding("module","global:BetaJS.Data.Google"),e.binding("base","global:BetaJS"),e.binding("data","global:BetaJS.Data"),e.define("module:",function(){return{guid:"40dfb24a-cf2c-4992-bf16-725d5177b5c9",version:"0.0.14",datetime:1611462651941}}),e.assumeVersion("base:version","~1.0.96"),e.assumeVersion("data:version","~1.0.41"),e.define("module:Helpers.Google",["base:Promise","base:Time"],function(a,t){var r=require("googleapis"),s=require("@google-cloud/pubsub").PubSub;return{getUserProfile:function(e){var t=a.create();return r.google.gmail("v1").users.getProfile({auth:e,userId:"me"},t.asyncCallbackFunc()),t.mapSuccess(function(e){return e.data})},oauth2:function(e,t,n){return new r.google.auth.OAuth2(e,t,n)},oauth2WithCredentials:function(e,t,n){t=this.oauth2(e,t);return t.setCredentials(n),t},oauth2RefreshRequired:function(e){return e.credentials.expiry_date<t.now()},oauth2ForceRefresh:function(e){var t=a.create();return e.refreshAccessToken(t.asyncCallbackFunc()),t},oauth2EnsureRefreshed:function(e){return this.oauth2RefreshRequired(oauth)?this.oauth2ForceRefresh(e):a.value(!0)},oauth2GetToken:function(e,t){var n=a.create();return e.getToken(t,n.asyncCallbackFunc()),n},oauth2Url:function(e,t){return e.generateAuthUrl({access_type:"offline",prompt:"consent",scope:t})},gmailWatch:function(e,t){var n=a.create();return r.google.gmail("v1").users.watch({userId:"me",auth:e,resource:{labelIds:["INBOX"],topicName:"projects/"+t.project_id+"/topics/"+t.topic_name}},n.asyncCallbackFunc()),n},pubsubSubscribe:function(e,n,a){var t=new s({projectId:e.project_id,credentials:{private_key:e.private_key,client_email:e.client_email}}),e="projects/"+e.project_id+"/subscriptions/"+e.subscription_name;t.subscription(e).on("message",function(e){try{n.call(a,e.id,JSON.parse(e.data),e.attributes)}catch(t){console.log(t)}e.ack()})}}}),e.define("module:Net.Imap",["base:Class","base:Events.EventsMixin","base:Objs","base:Async","base:Promise","base:Types"],function(e,t,o,r,n,c,a){return e.extend({scoped:a},[t,function(a){return{constructor:function(e,t){a.constructor.call(this),this.__quoted_printable=require("quoted-printable"),this.__html_strip=require("string-strip-html"),this.__auth=e,t=t||{},this.__options=t,this.__count=0,this.__Imap=require("imap"),this.__connected=!1,this.__imap=new this.__Imap(o.extend({tls:!0,tlsOptions:{rejectUnauthorized:!1}},e));var n=this;this.__imap.on("mail",function(e){n.__count+=e}),this.__imap.on("error",function(){n.trigger("error"),t.reconnect_on_error&&r.eventually(n.reconnect,[],n)})},destroy:function(){this.disconnect(),a.destroy.call(this)},connect:function(){if(this.__connected)return n.value(!0);this.__count=0;var r=this,s=n.create(),i=function(){s.error(!0),r.off("error",i)};return this.on("error",i),this.__imap.connect(),this.__imap.once("ready",function(){r.__connected=!0;var t=r.__options.mailbox||"INBOX";c.is_array(t)||(t=[t]),t=o.clone(t,1);var n=null,a=function(){0===t.length&&(s.error(n),r.__connected=!1);var e=t.shift();r.__imap.openBox(e,!0,function(e,t){return e?(n=e,void a()):(r.on("error",i),r.__imap.on("mail",function(e){r.trigger("new_mail",e)}),void s.asyncSuccess(!0))})};r.off("error",i),a()}),s},disconnect:function(){this.__connected&&(this.__imap.end(),this.__connected=!1)},reconnect:function(){this.disconnect(),this.connect()},count:function(){return this.__count},fetch:function(e,t){var n=[];"headers"in(e=e||{})&&!e.headers||n.push("HEADER.FIELDS (FROM TO SUBJECT DATE)"),"body"in e&&!e.body||n.push("TEXT");var a=1,r=100;e.seq_count?e.seq_end?a=(r=e.seq_end)-e.seq_count+1:r=(a=e.seq_start||a)+e.seq_count-1:(a=e.seq_start||a,r=e.seq_end||a+99),e.reverse&&(e=r-a,a=(r=this.__count-a+1)-e);n=this.__imap.seq.fetch(a+":"+r,{bodies:n,struct:!0});return this.__query(n)},__query:function(e){var i=this,o=[];e.on("message",function(e,n){var a={},r="",s="";e.on("body",function(e,t){e.on("data",function(e){"TEXT"===t.which?s+=e.toString("utf8"):r+=e.toString("utf8")})}),e.once("attributes",function(e){a=e}),e.once("end",function(){a.seqno=n;try{var e=i.__parse(i.__Imap.parseHeader(r),s,a);e&&o.push(e)}catch(t){}})});var t=n.create();return e.once("error",function(e){t.asyncError(e)}),e.once("end",function(){t.asyncSuccess(o)}),t},__parse:function(e,t,n){this.trigger("parse",e,t,n);var a={};if(a.uid=n.uid,a.threadid=n["x-gm-thrid"],a.id=n.uid,a.seqid=n.seqno,e&&e.subject&&0<e.subject.length&&(a.subject=e.subject[0]),e&&e.to&&0<e.to.length&&(a.to=e.to[0]),e&&e.from&&0<e.from.length&&(a.from=e.from[0]),e&&e.date&&0<e.date.length&&(e=new Date(e.date[0]),a.time=e.getTime()),t){var r=n.struct,s=[];if(1<r.length)for(var i=r[0].params.boundary,o=(u=t).indexOf(i),c=1;c<r.length;++c){var u,d,l=r[c][0]||{};u=(u=u.substring(u.indexOf(i)+i.length)).substring(u.indexOf("\r\n\r\n")+"\r\n\r\n".length),l.disposition||"text"!==l.type||(d=u.indexOf(i)-o,s.push({meta:l,body:0<=d?u.substring(0,d):u}))}else s.push({meta:r[0],body:t});for(var _=null,m=null,f=0;f<s.length;++f){var h=s[f].body,p=s[f].meta.encoding.toLowerCase();try{h=("quoted-printable"===p?this.__quoted_printable.decode(h):new Buffer(h,p)).toString()}catch(g){}"html"===s[f].meta.subtype?_=h:m=h}!m&&_&&(m=this.__html_strip(_)),a.html_body=_,a.text_body=m}return a}}}])}),e.define("module:Net.Smtp",["base:Strings","base:Promise"],function(r,s){return{send:function(e,t){var n=require("emailjs");t.from=r.email_get_email(t.from),t.to=r.email_get_email(t.to),t.text_body&&(t.text=t.text_body,delete t.text_body);var a=s.create();return n.server.connect(e).send(n.message.create(t),a.asyncCallbackFunc()),a}}}),e.define("module:Stores.GoogleRawCalendarStore",["data:Stores.BaseStore","data:Queries","base:Promise","base:Objs","base:Time"],function(e,t,a,r,s,n){return e.extend({scoped:n},function(n){return{constructor:function(e,t){n.constructor.call(this),this.__calendar=require("googleapis").google.calendar("v3"),this.__google=e,this.__calendarId=t},_query_capabilities:function(){return{limit:!0,skip:!1,sort:!0,query:t.fullQueryCapabilities()}},_query:function(e,t){if(e.id)return this.get(e.id).mapSuccess(function(e){return[e]});var n=a.create(),e=r.extend({auth:this.__google,calendarId:this.__calendarId,maxResults:t.limit||100,singleEvents:!0,timeZone:"UTC"},e);return this.__calendar.events.list(e,n.asyncCallbackFunc()),n.mapSuccess(function(e){return e.data.items},this)},_get:function(e){var t=a.create();return this.__calendar.events.get({auth:this.__google,calendarId:this.__calendarId,eventId:e},t.asyncCallbackFunc()),t},_remove:function(e){var t=a.create();return this.__calendar.events["delete"]({auth:this.__google,calendarId:this.__calendarId,eventId:e},t.asyncCallbackFunc()),t},_update:function(e,t){return a.value(t)},_insert:function(t){var e=a.create();return this.__calendar.events.quickAdd({auth:this.__google,calendarId:this.__calendarId,text:t.value},e.asyncCallbackFunc()),e.mapSuccess(function(e){return{id:e.eventId,value:t.value,start_date_utc:s.now(),start_date_utc_time_difference:null}})}}})}),e.define("module:Stores.GoogleCalendarStore",["data:Stores.TransformationStore","data:Queries","module:Stores.GoogleRawCalendarStore","base:Objs","base:Strings"],function(e,t,a,i,r,n){return e.extend({scoped:n},function(n){return{constructor:function(e,t){n.constructor.call(this,new a(e,t),{destroy_store:!0})},_query_capabilities:function(){var e=n._query_capabilities.call(this);return e.sort=!0,e},_encodeData:function(e){var n={};return i.iter(e,function(e,t){"date"==t?n.Date=e:n[t]=e},this),n},_decodeData:function(e){if(e.value)return e;var t,n={id:e.id,value:e.summary,start_date_utc:null,start_date_utc_time_difference:null};return e.start&&e.start.dateTime&&(t=r.last_after(e.start.dateTime,"-").split(":"),n.start_date_utc=new Date(e.start.dateTime).getTime(),n.start_date_utc_time_difference=60*parseInt(t[0],10)+parseInt(t[1],10)),n},_encodeQuery:function(e,t){var r={};return function s(e){i.iter(e,function(e,t){switch(t){case"start_date_utc":var n=e.$gte||e.$gt,a=e.$lte||e.$lt;n&&(r.timeMin=new Date(n).toISOString()),a&&(r.timeMax=new Date(a).toISOString());break;case"value":r.q=e;break;default:s(e)}})}(e),{query:r,options:t}}}})}),e.define("module:Stores.GoogleContactsStore",["data:Stores.BaseStore","data:Queries","base:Promise","base:Objs","base:Strings"],function(e,n,a,t,r,s){return e.extend({scoped:s},function(t){return{constructor:function(e){t.constructor.call(this),this.__contacts=new(require("google-contacts").GoogleContacts)({token:e.credentials.access_token}),this.__google=e},_query_capabilities:function(){return{limit:!0,skip:!1,sort:!0,query:n.fullQueryCapabilities()}},_query:function(e,t){if(e.id)return this.get(e.id).mapSuccess(function(e){return[e]});t=t||{};var n=a.create();return this.__contacts.getContacts(n.asyncCallbackFunc(),{projection:"full","max-results":t.limit,q:[e.name||"",e.email||""].join(" ")}),n.mapSuccess(function(e){return e.map(this._decodePerson,this)},this)},_get:function(e){var t=a.create();return this.__contacts.getContact(t.asyncCallbackFunc(),{id:e}),t.mapSuccess(this._decodePerson,this)},_decodePerson:function(e){return{id:(e=e.entry||e).id,name:e.name,email:e.email?e.email.toLowerCase():"",phoneNumber:e.phoneNumber}}}})}),e.define("module:Stores.GoogleRawMailStore",["data:Stores.BaseStore","data:Queries","base:Promise","base:Objs","base:Time","base:Types"],function(e,t,i,o,n,s,a){var c={to:"to",cc:"cc",bcc:"bcc","in-reply-to":"In-Reply-To",references:"References",subject:"subject",text:"text_body",attachments:"attachments"},u={sent:"SENT",draft:"DRAFT",starred:"STARRED",spam:"SPAM",trash:"TRASH",important:"IMPORTANT",cat_personal:"CATEGORY_PERSONAL",cat_social:"CATEGORY_SOCIAL",cat_promotions:"CATEGORY_PROMOTIONS",cat_updates:"CATEGORY_UPDATES",cat_forums:"CATEGORY_FORUMS"},d={archived:"INBOX",read:"UNREAD"},l={sent:!0,draft:!0};return e.extend({scoped:a},function(t){return{constructor:function(e){t.constructor.call(this),this.__gmail=require("googleapis").google.gmail("v1"),this.__google=e},_query_capabilities:function(){return{limit:!0,skip:!1,sort:!0,query:{atom:!0,conditions:{$ct:!0,$ctic:!0,$sw:!0,$swic:!0}}}},__gmailExecute:function(n,a,r,e){return i.resilience(function(){var e=i.create(),t=this.__gmail.users;return a.split(".").forEach(function(e){t=t[e]}),t[n](o.extend({auth:this.__google,userId:"me"},r),e.asyncCallbackFunc()),e},this,e||5)},__isDraft:function(e){return 0===e.indexOf("r")},_get:function(t){var n=this.__isDraft(t);return this.__gmailExecute("get",n?"drafts":"messages",{id:t,format:"full"}).mapSuccess(function(e){e=n?e.data.message:e.data;return e.id=t,e})},getAttachment:function(e,t){return this.__gmailExecute("get","messages.attachments",{messageId:e,id:t})},__rawMessageByData:function(n){var e=require("mailcomposer"),a={};o.iter(c,function(e,t){e in n&&(a[t]=n[e])});var e=e(a),r=i.create();return e.build(function(e,t){r.asyncSuccess(t.toString("base64").replace(/\+/g,"-").replace(/\//g,"_"))}),r},_insert:function(t){var n=t.draft;return t.threadId&&0<=t.threadId.indexOf("-")&&delete t.threadId,this.__rawMessageByData(t).mapSuccess(function(e){return this.__gmailExecute(n?"create":"send",n?"drafts":"messages",{resource:n?{message:{threadId:t.threadId,raw:e}}:{threadId:t.threadId,raw:e}}).mapSuccess(function(e){return this.get(e.data.id)},this)},this)},_query:function(n,e){if(n.id)return this.get(n.id).mapSuccess(function(e){return[e.data||e]});var a,r;return(n.threadId?this.__gmailExecute("get","threads",{id:n.threadId,maxResults:e.limit||100}):(a=[],o.iter(n,function(e,n){s.is_object(e)?o.iter(e,function(e,t){"$ct"!==t&&"$ctic"!==t||a.push(n+":*"+e+"*"),"$sw"!==t&&"$swic"!==t||a.push(n+":"+e+"*")}):"primary"===n&&e?a.push("in:inbox -category:{social promotions forums}"):"primary"!==n||e?n in u||n in d||a.push(n+":"+e):a.push("category:{social promotions forums}")}),r=[],o.iter(u,function(e,t){t in n&&n[t]&&r.push(e)}),o.iter(d,function(e,t){t in n&&!n[t]&&r.push(e)}),e={maxResults:e.limit||100},0<r.length&&(e.labelIds=r),0<a.length&&(e.q=a.join(" ")),this.__gmailExecute("list","messages",e))).mapSuccess(function(e){var t=i.and();o.iter(e.data.messages,function(e){t=t.and(this.get(e.id))},this);var n=t.end();return this.__allDrafts().mapError(function(){return n}).mapSuccess(function(e){var t={};return e.forEach(function(e){t[e.message.id]=e.id}),n.mapSuccess(function(e){return e.map(function(e){return t[e.id]&&(e.id=t[e.id]),e})})})},this)},_remove:function(e){return this.__gmailExecute("delete","messages",{id:e,format:"full"})},__allDrafts:function(){return this.__gmailExecute("list","drafts",{}).mapSuccess(function(e){return e.data.drafts||[]})},__draftByMsgId:function(n){return this.__allDrafts().mapSuccess(function(e){for(var t=0;t<e.length;++t)if(e[t].message.id===n)return e[t];return i.error("Not found")},this)},__draftByDraftId:function(n){return this.__gmailExecute("list","drafts",{}).mapSuccess(function(e){for(var t=0;t<e.data.drafts.length;++t)if(e.data.drafts[t].id===n)return e.data.drafts[t];return i.error("Not found")},this)},_update:function(a,r){if(r.threadId&&0<=r.threadId.indexOf("-")&&delete r.threadId,"draft"in r&&!r.draft)return 1<o.count(r)?(delete r.draft,this._update(a,r).mapSuccess(function(){return this._update(a,{draft:!1})},this)):this.__draftByDraftId(a).mapSuccess(function(e){return this.__gmailExecute("send","drafts",{resource:{id:e.id,message:e.message}}).mapSuccess(function(e){return this.get(e.data.id)},this)},this);if(this.__isDraft(a))return this._get(a).mapSuccess(function(t){var e,n;return o.iter(t.payload.headers,function(e){e.name.toLowerCase()in r||(r[e.name.toLowerCase()]=e.value)}),"text_body"in r||!t.payload.body||!t.payload.body.data||(e=new Buffer(t.payload.body.data,"base64"),r.text_body=e.toString()),r.attachments?(r.addAttachments=r.attachments,r.attachments=[]):(r.attachments=[],(n=function(e){o.iter(e,function(e){try{switch(e.mimeType){case"text/plain":"text_body"in r||(r.text_body=new Buffer(e.body.data,"base64").toString());break;case"text/html":break;case"multipart/alternative":n(e.parts);break;default:e.body&&e.body.attachmentId&&r.attachments.push({type:e.mimeType,name:e.filename,id:e.body.attachmentId})}}catch(t){}})})(t.payload.parts||[t.payload])),i.and(r.attachments.map(function(t){return this.getAttachment(a,t.id).mapSuccess(function(e){return{contentType:t.type,filename:t.name,content:new Buffer(e.data.data,"base64")}})},this)).end().mapSuccess(function(e){return r.attachments=e,r.attachmentsAdd&&(r.attachments=r.attachments.concat(r.attachmentsAdd.map(function(e){return{filename:e.name,content:e.data}})),delete r.attachmentsAdd),this.__rawMessageByData(o.extend(t,r)).mapSuccess(function(e){return this.__gmailExecute("update","drafts",{id:a,resource:{message:{raw:e}}}).mapSuccess(function(e){return this.get(e.data.id)},this)},this)},this)},this);var n=[],s=[];return o.iter(u,function(e,t){t in r&&!(t in l)&&(r[t]?n:s).push(e)}),o.iter(d,function(e,t){t in r&&!(t in l)&&(r[t]?s:n).push(e)}),0<n.length+s.length?this.__gmailExecute("modify","messages",{id:a,resource:{addLabelIds:n,removeLabelIds:s}}):i.value({})}}})}),e.define("module:Stores.GoogleMailStore",["data:Stores.TransformationStore","data:Queries","module:Stores.GoogleRawMailStore","base:Objs","base:Promise"],function(e,t,n,s,a,r){var i={sent:"SENT",draft:"DRAFT",starred:"STARRED",spam:"SPAM",trash:"TRASH",important:"IMPORTANT",cat_personal:"CATEGORY_PERSONAL",cat_social:"CATEGORY_SOCIAL",cat_promotions:"CATEGORY_PROMOTIONS",cat_updates:"CATEGORY_UPDATES",cat_forums:"CATEGORY_FORUMS"},o={archived:"INBOX",read:"UNREAD"};return e.extend({scoped:r},function(t){return{constructor:function(e){t.constructor.call(this,new n(e),{destroy_store:!0})},_query_capabilities:function(){var e=t._query_capabilities.call(this);return e.sort=!0,e},getAttachment:function(e,t){return this._store().getAttachment(e,t)},addAttachments:function(e,t){return this.update(e,{attachmentsAdd:t}).mapSuccess(function(e){return e.attachments.slice(-t.length)})},_encodeData:function(e){var n={labelIds:[]};return s.iter(e,function(e,t){if(null!==e&&e!==undefined)switch(t){case"time":n.Date=e;break;case"threadid":n.threadId=e;break;case"in_reply_to":n["In-Reply-To"]=e;break;case"to":case"cc":case"bcc":n[t]=e.join?e.join(","):e;break;case"references":n.References=e;break;default:n[t]=e}},this),0===n.labelIds.length&&delete n.labelIds,n},_decodeData:function(n){if(!n.payload)return n;var a={id:n.id,threadid:n.threadId,snippet:n.snippet,attachments:[],to:[],cc:[]};s.iter(i,function(e,t){a[t]=s.contains_value(n.labelIds,e)}),s.iter(o,function(e,t){a[t]=!s.contains_value(n.labelIds,e)}),a.primary=!1,!s.contains_value(n.labelIds,"INBOX")||s.contains_value(n.labelIds,"SOCIAL")||s.contains_value(n.labelIds,"PROMOTIONS")||s.contains_value(n.labelIds,"FORUMS")||(a.primary=!0),s.iter(n.payload.headers,function(e){switch(e.name){case"To":a.to=a.to.concat(e.value.split(",").map(function(e){return e.trim()}));break;case"Cc":a.cc=a.cc.concat(e.value.split(",").map(function(e){return e.trim()}));break;case"From":a.from=e.value;break;case"Subject":a.subject=e.value;break;case"Date":a.creation_time=Date.parse(e.value);break;case"Message-Id":a.messageid=e.value}});var r=function(e){s.iter(e,function(e){try{switch(e.mimeType){case"text/plain":a.text_body=new Buffer(e.body.data,"base64").toString();break;case"text/html":a.html_body=new Buffer(e.body.data,"base64").toString();break;case"multipart/alternative":r(e.parts);break;default:e.body&&e.body.attachmentId&&a.attachments.push({type:e.mimeType,filename:e.filename,id:e.body.attachmentId,size:e.body.size,internal:!!a.html_body&&0<=a.html_body.indexOf("cid:"+e.filename)})}}catch(t){}})};return r(n.payload.parts||[n.payload]),a}}})}),e.define("module:Stores.GooglePeopleStore",["data:Stores.BaseStore","data:Queries","base:Promise","base:Objs","base:Strings"],function(e,n,a,r,s,t){var i=["addresses","ageRanges","biographies","birthdays","braggingRights","coverPhotos","emailAddresses","events","genders","imClients","interests","locales","memberships","metadata","names","nicknames","occupations","organizations","phoneNumbers","photos","relations","relationshipInterests","relationshipStatuses","residences","skills","taglines","urls"];return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this),this.__people=require("googleapis").google.people("v1"),this.__google=e},_query_capabilities:function(){return{limit:!0,skip:!1,sort:!0,query:n.fullQueryCapabilities()}},_query:function(e,t){if(e.id)return this.get(e.id).mapSuccess(function(e){return[e]});var n=a.create();return this.__people.contactGroups.get(r.extend({auth:this.__google,resourceName:"contactGroups/all",maxMembers:t.limit||100},e),n.asyncCallbackFunc()),n.mapSuccess(function(e){var t=a.create();return this.__people.people.getBatchGet({auth:this.__google,resourceNames:e.data.memberResourceNames||[],personFields:i},t.asyncCallbackFunc()),t.mapSuccess(function(e){return e.data.responses.filter(function(e){return 200===e.httpStatusCode}).map(this._decodePerson,this)},this)},this)},_get:function(e){var t=a.create();return this.__people.people.get({auth:this.__google,resourceName:this._encodePersonId(e),personFields:i},t.asyncCallbackFunc()),t.mapSuccess(this._decodePerson,this)},_encodePersonId:function(e){return"people/"+s.strip_start(e,"people/")},_decodePersonId:function(e){return s.strip_start(e,"people/")},_decodePerson:function(e){e=e.person||e,e={id:this._decodePersonId(e.resourceName),emailAddresses:(e.emailAddresses||[]).map(function(e){return e.value.toLowerCase()}).filter(function(e){return s.is_email_address(e)}),gender:e.genders?e.genders[0].value:undefined,displayName:e.names?e.names[0].displayName:undefined,familyName:e.names?e.names[0].familyName:undefined,givenName:e.names?e.names[0].givenName:undefined,organization:e.organizations?e.organizations[0].name:undefined,title:e.organizations?e.organizations[0].title:undefined,photos:(e.photos||[]).map(function(e){return e.url}).filter(function(e){return!!e})};return e.name=e.displayName,e.email=e.emailAddresses[0],e}}})}),e.define("module:Stores.ImapStore",["data:Stores.BaseStore","data:Stores.StoreException","base:Objs","module:Net.Imap","module:Net.Smtp"],function(e,a,n,r,s,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this,e),this.__imap=n.extend(n.clone(e.base,1),e.imap),this.__smtp=n.extend(n.clone(e.base,1),e.smtp),this.__imap_opts=e.imap_options||{},this.__imap_opts.reconnect_on_error=!1},test:function(){var e=new r(this.__imap,this.__imap_opts);return e.connect().callback(e.destroy,e)},_query_capabilities:function(){return{skip:!0,limit:!0}},_query:function(e,t){var n=new r(this.__imap,this.__imap_opts);return n.connect().mapSuccess(function(){var e={};return"skip"in t&&(e.seq_start=t.skip+1),"limit"in t&&(e.seq_count=t.limit),e.reverse=!0,n.fetch(e).success(function(e){n.destroy()},this)},this)},_insert:function(n){s.send(this.__smtp,{from:n.from,to:n.to,subject:n.subject,text_body:n.text_body}).mapCallback(function(e,t){return e?new a(e):(n.id=t.header["message-id"],n)})}}})})}).call(Scoped);